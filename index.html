<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>cronos@alexandre.pro.br v1.63</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; height: 100vh; overflow: hidden; cursor: default; }
        
        /* --- CONFIGURA√á√ÉO --- */
        #config-screen { padding: 20px; height: 100vh; overflow-y: auto; box-sizing: border-box; max-width: 1200px; margin: 0 auto; }
        
        .painel-top { 
            background: #1e1e1e; padding: 15px; border-radius: 8px; border-left: 5px solid #00d2ff; 
            margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; 
        }
        .campo { display: flex; flex-direction: column; }
        .campo label { font-size: 0.8rem; color: #bbb; margin-bottom: 5px; }
        
        input, select { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; }
        input:disabled { background: #222; color: #555; border-color: #333; cursor: not-allowed; }

        .time-group { display: flex; align-items: center; gap: 5px; }
        .btn-small { background: #444; border: 1px solid #666; color: #fff; width: 30px; height: 35px; border-radius: 4px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; padding: 0; transition: 0.2s; }
        .btn-small:hover:not(:disabled) { background: #00d2ff; color: #000; border-color: #00d2ff; }
        .btn-small:disabled { opacity: 0.3; cursor: not-allowed; background: #222; border-color: #444; }
        
        #global-titulo {
            background: transparent; border: none; font-size: 1.8rem; font-weight: bold; 
            color: #00d2ff; width: 100%; padding: 5px; margin: 0;
        }
        #global-titulo:focus { outline: 1px dashed #555; background: rgba(255,255,255,0.05); }

        .btn-file { background: #444; border: 1px solid #666; color: #fff; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; text-decoration: none; }
        .btn-file:hover { background: #555; border-color: #888; color: #fff; }

        .btn-icon { background: transparent; border: 1px solid #555; color: #aaa; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: #444; color: #fff; }

        .chk-label { display: flex; align-items: center; gap: 5px; cursor: pointer; margin: 0; font-size: 0.9rem; }
        .chk-input { width: 18px; height: 18px; cursor: pointer; }

        input[type="color"] {
            -webkit-appearance: none; border: 1px solid #555; width: 50px; height: 40px; padding: 0;
            background: none; cursor: pointer; border-radius: 4px; overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
        
        .fase-wrapper { margin-bottom: 10px; border: 1px solid #444; border-radius: 6px; background: #252526; overflow: hidden; }
        .fase-row { padding: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .audio-panel { background: #151515; padding: 10px; border-top: 1px dashed #444; display: none; }
        .audio-panel.open { display: block; }
        
        .audio-slot { 
            display: flex; gap: 10px; align-items: flex-end; margin-bottom: 8px; 
            background: #222; padding: 8px; border-radius: 4px; border-left: 3px solid #00d2ff; flex-wrap: wrap; transition: opacity 0.3s;
        }
        .audio-slot .grp { display: flex; flex-direction: column; transition: opacity 0.3s, width 0.3s; }
        .audio-slot label { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
        .audio-slot input[type="number"] { width: 50px; padding: 5px; font-size: 0.9rem; background: #333; border: 1px solid #555; }
        .aud-warn { color: #ffaa00; font-size: 0.8rem; font-style: italic; display: flex; align-items: center; gap: 5px; width: 100%; margin-top: 5px;}
        
        .grp.disabled { opacity: 0.3; pointer-events: none; }
        .grp.vanish { display: none; }

        .col-intervalo { background: rgba(255, 170, 0, 0.15); padding: 5px; border-radius: 4px; display: flex; gap: 5px; border: 1px dashed #666; }
        .col-estouro { background: rgba(255, 68, 68, 0.15); padding: 5px; border-radius: 4px; display: flex; gap: 5px; border: 1px dashed #666; }
        .col-audio { background: rgba(0, 210, 255, 0.15); padding: 5px; border-radius: 4px; display: flex; gap: 5px; border: 1px dashed #666; }
        
        .hidden { display: none !important; }

        #lista-fases .fase-wrapper:last-child .col-intervalo { visibility: hidden; pointer-events: none; }
        #lista-fases .fase-wrapper:last-child .col-estouro { display: none; }

        .btn-x { background: #ff4444; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .btn-add { background: #444; color: white; border: 1px solid #666; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn-go { background: linear-gradient(135deg, #00d2ff, #0072ff); color: white; border: none; padding: 15px; flex-grow: 1; font-weight: bold; font-size: 1.1rem; border-radius: 4px; cursor: pointer; }

        /* --- APRESENTA√á√ÉO --- */
        #display-screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; background-color: #000; background-size: cover; background-position: center; position: relative; transition: background-color 0.5s; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1; }
        
        #relogio-real { position: absolute; top: 15px; right: 20px; z-index: 20; font-size: 1.5rem; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; border: 1px solid #444; }
        #btn-sair { position: absolute; top: 15px; left: 20px; z-index: 20; background: none; border: none; color: #555; font-size: 1.2rem; cursor: pointer; }

        .conteudo-box { z-index: 10; text-align: center; padding: 40px; border-radius: 20px; background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(5px); min-width: 60%; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        
        #display-global-titulo { font-size: 1.5rem; color: #fff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; opacity: 0.8; }
        #titulo-fase { font-size: 2.5rem; margin: 0; text-transform: uppercase; color: #fff; letter-spacing: 2px; position: relative; z-index: 1; }
        
        #lbl-fim { position: absolute; top: 0; left: 0; width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; font-size: 8rem; color: #ff4444; font-weight: 900; background: rgba(0,0,0,0.95); z-index: 50; border-radius: 20px 20px 0 0; line-height: 1; text-transform: uppercase; opacity: 0; pointer-events: none; }
        #lbl-fim.ativo { opacity: 1; }

        #timer-principal { font-size: 9rem; margin: 0; font-weight: bold; line-height: 1; font-variant-numeric: tabular-nums; position: relative; z-index: 1; transition: font-size 0.5s ease; }
        .timer-waiting { font-size: 4rem !important; color: #777 !important; text-shadow: none !important; }

        #info-horarios { display: flex; justify-content: center; gap: 40px; margin-top: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; font-size: 1.1rem; color: #aaa; }
        #info-horarios span { display: flex; align-items: center; gap: 8px; }

        #rodape-info { margin-top: 15px; font-size: 1.2rem; color: #aaa; padding-top: 10px; display: flex; justify-content: space-between;}

        .controles-play { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-ctrl { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; min-width: 120px; transition: background 0.2s;}
        .btn-ctrl:hover { background: rgba(255,255,255,0.2); }
        .btn-proximo { background: #ffaa00; color: #000; font-weight: bold; font-size: 1.5rem; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; margin-top: 20px; }

        /* MODAIS */
        .modal-base { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; max-width: 500px; text-align: center; }
        .modal-opts { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 15px; border: none; background: #333; color: white; text-align: left; cursor: pointer; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .btn-modal:hover { background: #444; }
        .btn-modal b { font-size: 1.1em; }

        /* Modal Espec√≠fico: Sobra de Tempo */
        .dist-option { border-left: 4px solid #00d2ff; }
        .dist-option:hover { background: rgba(0, 210, 255, 0.1); }

        #modal-audio-pause { z-index: 110; }
        .audio-pause-box { background: #222; padding: 25px; border-radius: 10px; border: 1px solid #00d2ff; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,210,255,0.3); }
        .btn-aud-opt { padding: 12px; border: none; color: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; text-align: left; font-size: 1rem; width: 100%; margin-bottom: 10px;}
        
        #custom-tooltip { position: fixed; background: rgba(0, 0, 0, 0.95); border: 1px solid #00d2ff; color: #fff; padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; pointer-events: none; z-index: 9999; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.8); max-width: 250px; line-height: 1.4; }

        /* Anima√ß√µes */
        .piscando-cor { animation: pulse-opacity 1s infinite; }
        @keyframes pulse-opacity { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.02); } }
        .piscando-vermelho { color: #ff4444 !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); text-shadow: 0 0 20px red; } }
        .piscando-alerta-maximo { animation: flash-timer-panic 0.5s infinite; }
        @keyframes flash-timer-panic { 0%, 49% { color: #ff4444; transform: scale(1.05); } 50%, 100% { color: var(--txt-color); transform: scale(1); } }
        .bg-panic { animation: bg-flash 1s infinite; }
        @keyframes bg-flash { 0%, 100% { background-color: #300000; } 50% { background-color: #aa0000; } }
        @keyframes flash-strobe { 0%, 15% { opacity: 1; } 16%, 100% { opacity: 0; } }
        @keyframes flash-strobe-panic { 0%, 15% { color: #ff4444; opacity: 1; } 16%, 49% { opacity: 0; } 50%, 65% { color: var(--txt-color); opacity: 1; } 66%, 100% { opacity: 0; } }
        .anim-slow { animation: flash-strobe 2.5s infinite; }
        .anim-med { animation: flash-strobe 1.5s infinite; }
        .anim-fast { animation: flash-strobe 0.5s infinite; }
        .anim-panic { animation: flash-strobe-panic 0.4s infinite; }
    </style>
</head>
<body>

    <div id="custom-tooltip"></div>
    <input type="file" id="file-input" style="display: none;" accept=".json" onchange="carregarArquivo(this)">

    <div id="config-screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px; flex-grow:1; margin-right:20px;">
                <input type="text" id="global-titulo" value="Escola Sabatina Viva" data-tooltip="Clique para editar o t√≠tulo do evento.">
                <input type="color" id="global-cor-titulo" value="#00d2ff" style="width:40px; height:35px; border:none;" data-tooltip="Alterar cor do t√≠tulo.">
                <label class="chk-label" data-tooltip="Se marcado, exibe este t√≠tulo na tela de apresenta√ß√£o."><input type="checkbox" id="chk-exibir-titulo" class="chk-input"> Exibir</label>
            </div>
            <div style="display:flex; gap:10px;">
                <a href="manual.html" target="_blank" class="btn-file" data-tooltip="Ver Manual de Uso">‚ùì Manual</a>
                <a href="sobre.html" target="_blank" class="btn-file" data-tooltip="Sobre o Projeto">‚ÑπÔ∏è Sobre</a>
                <button class="btn-file" onclick="salvarConfiguracao()" data-tooltip="Salvar a programa√ß√£o.">üíæ Salvar</button>
                <button class="btn-file" onclick="document.getElementById('file-input').click()" data-tooltip="Carregar programa√ß√£o.">üìÇ Abrir</button>
            </div>
        </div>
        
        <div class="painel-top">
            <div class="campo" data-tooltip="In√≠cio da programa√ß√£o.">
                <label>In√≠cio Planejado</label>
                <div class="time-group" id="group-inicio">
                    <input type="time" id="hora-inicio">
                    <button class="btn-small" onclick="calcSetInicioAgora()" data-tooltip="Definir para AGORA">‚è±Ô∏è</button>
                    <button class="btn-small" onclick="calcInicioPeloFim()" data-tooltip="Calcular In√≠cio baseado no Fim">‚è™</button>
                </div>
                <label class="chk-label" style="margin-top:5px; font-size:0.8rem; color:#aaa;">
                    <input type="checkbox" id="chk-ignorar-inicio" class="chk-input" onchange="toggleIgnorarInicio()"> Ignorar In√≠cio
                </label>
            </div>
            
            <div class="campo" data-tooltip="Hor√°rio limite.">
                <label>Fim Absoluto</label>
                <div class="time-group" id="group-fim">
                    <input type="time" id="hora-fim">
                    <button class="btn-small" onclick="calcFimPeloInicio()" data-tooltip="Calcular Fim baseado no In√≠cio">‚è©</button>
                </div>
                <label class="chk-label" style="margin-top:5px; font-size:0.8rem; color:#aaa;">
                    <input type="checkbox" id="chk-ignorar-fim" class="chk-input" onchange="toggleIgnorarFim()"> Ignorar Fim (Livre)
                </label>
            </div>
            
            <div class="campo" style="flex-direction: row; align-items: center; gap: 20px; padding-bottom: 5px;">
                <label class="chk-label" data-tooltip="Habilita a l√≥gica de intervalos."><input type="checkbox" id="chk-intervalos" onchange="toggleIntervalosGlobais()" class="chk-input"> Intervalos</label>
                <label class="chk-label" data-tooltip="Habilita contagem negativa."><input type="checkbox" id="chk-estouro-global" onchange="toggleEstouroGlobal()" class="chk-input"> Permitir Estouro</label>
                <label class="chk-label" data-tooltip="Habilita sons."><input type="checkbox" id="chk-audio-global" onchange="toggleAudioGlobal()" class="chk-input"> Permitir √Åudio</label>
            </div>
        </div>

        <div id="lista-fases"></div>

        <div style="display:flex; gap:15px; margin-top:20px; padding-bottom:50px;">
            <button class="btn-add" onclick="adicionarFase()" data-tooltip="Adiciona nova linha.">+ Nova Etapa</button>
            <button class="btn-go" onclick="iniciarApresentacao()" data-tooltip="Inicia o cron√¥metro.">INICIAR ‚ñ∑</button>
        </div>
    </div>

    <div id="display-screen">
        <button id="btn-sair" onclick="encerrar()" title="Sair" data-tooltip="Sair">‚úï</button>
        <div class="overlay"></div>
        <div id="relogio-real" data-tooltip="Hora Atual">--:--</div>

        <div class="conteudo-box" id="box-principal">
            <h1 id="display-global-titulo" class="hidden"></h1>
            <h2 id="titulo-fase">...</h2>
            <div id="lbl-fim">FIM</div>
            <div id="area-timer" data-tooltip="Tempo restante"><div id="timer-principal">00:00</div></div>
            
            <button id="btn-intervalo-manual" class="btn-proximo hidden" onclick="sairIntervaloManual()" data-tooltip="Iniciar pr√≥xima parte">INICIAR PR√ìXIMA PARTE ‚ñ∂</button>
            
            <div id="info-horarios">
                <span data-tooltip="Hor√°rio limite configurado (Fim Absoluto)">üèÅ Limite: <strong id="lbl-fim-absoluto" style="color:#e0e0e0">--:--</strong></span>
                <span data-tooltip="Previs√£o de t√©rmino baseada no tempo restante">üîÆ Previs√£o: <strong id="lbl-fim-previsto" style="color:#28a745">--:--</strong></span>
            </div>

            <div id="rodape-info"><span id="txt-status" style="color:#00d2ff;">Tempo Normal</span><span id="txt-proximo">Pr√≥ximo: ...</span></div>
            <div class="controles-play">
                <button id="btn-pausar" class="btn-ctrl" onclick="acaoPausar()" data-tooltip="Pausar ou Parar o tempo">‚è∏ PAUSAR</button>
                <button id="btn-continuar" class="btn-ctrl hidden" onclick="acaoContinuar()" data-tooltip="Continuar contagem">‚ñ∂ Continuar</button>
                <button class="btn-ctrl" onclick="acaoAdicionarTempo()" style="border-color:#00d2ff; color:#00d2ff;" data-tooltip="Adiciona 1 minuto extra.">+1 Min</button>
                <button class="btn-ctrl" onclick="acaoReiniciarFase()" style="border-color:#ffaa00; color:#ffaa00;" data-tooltip="Reiniciar etapa atual">‚Ü∫ Reiniciar</button>
                <button id="btn-avancar" class="btn-ctrl" onclick="acaoAvan√ßar()" style="border-color:#00d2ff; color:#00d2ff;" data-tooltip="Pular etapa.">‚è≠ Avan√ßar</button>
                <button class="btn-ctrl" onclick="encerrar()" style="border-color:#ff4444; color:#ff4444;" data-tooltip="Sair.">‚èπ Encerrar</button>
            </div>
        </div>
    </div>

    <div id="modal-decisao" class="modal-base">
        <div class="modal-box" style="border-color:#ff4444;">
            <h2 style="color:#ff4444; margin-top:0;">‚ö†Ô∏è Atraso Cr√≠tico</h2>
            <p>O tempo acabou. Como deseja proceder?</p>
            <div class="modal-opts">
                <button class="btn-modal" onclick="resolverConflito(1)"><b>1. Reduzir Todas</b></button>
                <button class="btn-modal" onclick="resolverConflito(2)"><b>2. Reduzir √öltima</b></button>
                <button class="btn-modal" onclick="resolverConflito(3)"><b>3. Ignorar Prazo</b></button>
                <button class="btn-modal" onclick="resolverConflito(4)"><b>4. Alterar Hor√°rio Final</b></button>
            </div>
        </div>
    </div>

    <div id="modal-conflito-calc" class="modal-base">
        <div class="modal-box" style="border-color:#ffaa00;">
            <h2 style="color:#ffaa00; margin-top:0;">‚ö†Ô∏è Tempo Insuficiente</h2>
            <p>Para terminar no hor√°rio estipulado, o evento deveria ter come√ßado no passado (<span id="span-hora-calc"></span>).</p>
            <div class="modal-opts">
                <button id="btn-distribuir-calc" class="btn-modal" style="background:#007bff; font-weight:bold;" onclick="resolverConflitoCalc(1)"><b>üìâ DISTRIBUIR</b> (Comprimir Fases)</button>
                <button class="btn-modal" style="background:#28a745; color:white;" onclick="resolverConflitoCalc(2)"><b>üïì AJUSTAR FIM</b> (Mover Fim para Frente)</button>
                <button class="btn-modal" style="background:#444;" onclick="resolverConflitoCalc(0)">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-early-start" class="modal-base">
        <div class="modal-box" style="border-color:#00d2ff;">
            <h2 style="color:#00d2ff; margin-top:0;">‚è≥ Tempo de Sobra</h2>
            <p>Existe uma folga de <b><span id="early-time">00:00</span></b> (aprox. <span id="surplus-display-val"></span> min).</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:#444;" onclick="handleEarlyStart('wait')"><b>‚è≥ INSERIR AGUARDE</b> (Pausar Agora)</button>
                <button class="btn-modal" style="background:#28a745; color:white;" onclick="handleEarlyStart('start')"><b>üéÅ DISTRIBUIR / GERENCIAR</b></button>
                <button class="btn-modal" style="background:#007bff; color:white;" onclick="handleEarlyStart('ignore')"><b>‚ñ∂ INICIAR DIRETO</b> (Terminar Cedo)</button>
            </div>
        </div>
    </div>

    <div id="modal-surplus-dist" class="modal-base">
        <div class="modal-box" style="border-color:#28a745;">
            <h2 style="color:#28a745; margin-top:0;">üéÅ Gerenciar Tempo Extra</h2>
            <div class="modal-opts">
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('all')"><b>1. Distribuir Geral</b> <span>(Todas Prop.)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('first')"><b>2. + 1¬™ Fase</b> <span id="lbl-first-phase" style="font-size:0.8em; color:#aaa;">(...)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('last')"><b>3. + √öltima Fase</b> <span>(Fim)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('flex')"><b>4. + Flex√≠veis</b> <span>(Redut√≠veis)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-audio-pause" class="modal-base" style="z-index: 110;">
        <div class="audio-pause-box">
            <h2 style="color:#00d2ff; margin-top:0;">üéµ √Åudio em Execu√ß√£o</h2>
            <p>O tempo parou, mas h√° um √°udio tocando. O que fazer?</p>
            <div class="audio-pause-opts">
                <button class="btn-aud-opt" style="background:#28a745;" onclick="resolverAudioPause('continue')">üîä PROSSEGUIR √ÅUDIO (Deixar tocando)</button>
                <button class="btn-aud-opt" style="background:#ffaa00; color:#000;" onclick="resolverAudioPause('pause')">‚è∏Ô∏è PAUSAR √ÅUDIO (Retoma ao voltar)</button>
                <button class="btn-aud-opt" style="background:#007bff;" onclick="resolverAudioPause('restart')">‚èÆÔ∏è REINICIAR √ÅUDIO (Do come√ßo)</button>
                <button class="btn-aud-opt" style="background:#ff4444;" onclick="resolverAudioPause('stop')">‚èπÔ∏è PARAR √ÅUDIO (Encerrar)</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('global-cor-titulo').addEventListener('input', e => document.getElementById('global-titulo').style.color = e.target.value);

        // --- SISTEMA DE UI: IGNORAR/ATIVAR ---
        function toggleIgnorarInicio() {
            const chk = document.getElementById('chk-ignorar-inicio');
            document.getElementById('hora-inicio').disabled = chk.checked;
            document.querySelectorAll('#group-inicio button').forEach(b => b.disabled = chk.checked);
        }
        function toggleIgnorarFim() {
            const chk = document.getElementById('chk-ignorar-fim');
            document.getElementById('hora-fim').disabled = chk.checked;
            document.querySelectorAll('#group-fim button').forEach(b => b.disabled = chk.checked);
        }

        // --- CALCULADORAS ---
        function obterDuracaoTotalMinutos() {
            let totalMin = 0;
            const rows = document.querySelectorAll('.fase-row');
            const globalInt = document.getElementById('chk-intervalos').checked;
            rows.forEach((r, idx) => {
                const m = parseFloat(r.querySelector('.inp-tempo').value) || 0;
                totalMin += m;
                if(globalInt && idx < rows.length - 1) {
                    const intS = parseInt(r.querySelector('.inp-int-tempo').value) || 0;
                    totalMin += (intS / 60);
                }
            });
            return totalMin;
        }

        function formatTime(date) { return String(date.getHours()).padStart(2,'0') + ":" + String(date.getMinutes()).padStart(2,'0'); }
        function calcSetInicioAgora() { document.getElementById('hora-inicio').value = formatTime(new Date()); }

        function calcFimPeloInicio() {
            const hI = document.getElementById('hora-inicio').value;
            if(!hI) return alert("Defina o in√≠cio primeiro.");
            const dur = obterDuracaoTotalMinutos();
            const d = montarData(hI, new Date());
            d.setMinutes(d.getMinutes() + Math.ceil(dur));
            document.getElementById('hora-fim').value = formatTime(d);
        }

        function calcInicioPeloFim() {
            const hF = document.getElementById('hora-fim').value;
            if(!hF) return alert("Defina o fim primeiro.");
            const dur = obterDuracaoTotalMinutos();
            const dFim = montarData(hF, new Date());
            const dIni = new Date(dFim.getTime() - (dur * 60000));
            
            const now = new Date();
            if(dIni < new Date(now.getTime() - 60000)) {
                document.getElementById('span-hora-calc').innerText = formatTime(dIni);
                const rows = document.querySelectorAll('.fase-row');
                let countRedut = 0; rows.forEach(r => { if(r.querySelector('.inp-redutivel').checked) countRedut++; });
                const btnDist = document.getElementById('btn-distribuir-calc');
                if(rows.length === 1 || countRedut > 0) btnDist.style.display = 'block'; else btnDist.style.display = 'none';
                document.getElementById('modal-conflito-calc').style.display = 'flex';
            } else {
                document.getElementById('hora-inicio').value = formatTime(dIni);
            }
        }

        function resolverConflitoCalc(opt) {
            document.getElementById('modal-conflito-calc').style.display = 'none';
            if(opt === 0) return; 
            if(opt === 2) { calcSetInicioAgora(); calcFimPeloInicio(); return; }
            if(opt === 1) {
                const hF = document.getElementById('hora-fim').value;
                const dFim = montarData(hF, new Date());
                if(dFim < new Date()) dFim.setDate(dFim.getDate()+1);
                const now = new Date();
                const tempoDisponivelMin = (dFim - now) / 60000;
                let tempoFixo = 0; let tempoRedutivelTotal = 0;
                const rows = Array.from(document.querySelectorAll('.fase-row'));
                const globalInt = document.getElementById('chk-intervalos').checked;
                rows.forEach((r, idx) => {
                    const m = parseFloat(r.querySelector('.inp-tempo').value) || 0;
                    const isRedut = rows.length === 1 || r.querySelector('.inp-redutivel').checked;
                    if(isRedut) tempoRedutivelTotal += m; else tempoFixo += m;
                    if(globalInt && idx < rows.length - 1) { tempoFixo += (parseInt(r.querySelector('.inp-int-tempo').value) || 0) / 60; }
                });
                const tempoParaRedutiveis = tempoDisponivelMin - tempoFixo;
                if(tempoParaRedutiveis <= 0) { alert("Tempo insuficiente."); return; }
                const fator = tempoParaRedutiveis / tempoRedutivelTotal;
                rows.forEach(r => {
                    const isRedut = rows.length === 1 || r.querySelector('.inp-redutivel').checked;
                    if(isRedut) {
                        const original = parseFloat(r.querySelector('.inp-tempo').value);
                        let novo = Math.floor(original * fator); if(novo < 1) novo = 1;
                        r.querySelector('.inp-tempo').value = novo;
                    }
                });
                calcSetInicioAgora();
                alert(`Redu√ß√£o aplicada: ${Math.round((1-fator)*100)}%`);
            }
        }

        // --- GLOBAIS DE SOBRA DE TEMPO ---
        let surplusMinutes = 0;
        let pendingDataInicio = null;

        function iniciarApresentacao() {
            const hI = document.getElementById('hora-inicio').value;
            const hF = document.getElementById('hora-fim').value;
            const ignorarI = document.getElementById('chk-ignorar-inicio').checked;
            const ignorarF = document.getElementById('chk-ignorar-fim').checked;

            if(!ignorarI && !hI) return alert("Defina o In√≠cio.");
            if(!ignorarF && !hF) return alert("Defina o Fim.");

            const now = new Date(); 
            let dIni;

            if(ignorarI) dIni = now; 
            else dIni = montarData(hI, now);

            if(!ignorarF) {
                dataFimGlobal = montarData(hF, now); 
                if(dataFimGlobal < dIni) dataFimGlobal.setDate(dataFimGlobal.getDate()+1);
            } else { dataFimGlobal = null; }

            // L√≥gica Unificada de Sobra de Tempo
            // Se N√ÉO ignorar fim, calculamos se sobra tempo
            if(!ignorarF) {
                const durationMin = obterDuracaoTotalMinutos();
                const availableMin = (dataFimGlobal - now) / 60000;
                const folga = Math.floor(availableMin - durationMin);

                // Se houver mais de 1 minuto de folga
                if(folga >= 1) {
                    surplusMinutes = folga;
                    const h = Math.floor(folga / 60);
                    const m = folga % 60;
                    document.getElementById('early-time').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    document.getElementById('surplus-display-val').innerText = folga;
                    
                    const firstRow = document.querySelector('.fase-row .inp-titulo');
                    document.getElementById('lbl-first-phase').innerText = firstRow ? `(${firstRow.value})` : '';

                    document.getElementById('modal-early-start').style.display = 'flex';
                    return; // PAUSA
                }
            }
            
            // Se chegou aqui, n√£o tem folga ou Fim √© livre.
            // Verifica se est√° muito adiantado em rela√ß√£o ao IN√çCIO (se n√£o ignorado)
            if(!ignorarI && now < dIni && !document.getElementById('modal-early-start').style.display.includes('flex')) {
                 iniciarEspera(dIni); return;
            }

            construirCronograma();
            rodarSistema(now);
        }

        function handleEarlyStart(choice) {
            document.getElementById('modal-early-start').style.display = 'none';
            
            if(choice === 'wait') {
                // Criar espera baseada na folga
                const now = new Date();
                const target = new Date(now.getTime() + (surplusMinutes * 60000));
                iniciarEspera(target);
            
            } else if (choice === 'start') {
                // Abrir distribui√ß√£o
                document.getElementById('modal-surplus-dist').style.display = 'flex';
            
            } else {
                // Ignore (iniciar direto)
                construirCronograma();
                rodarSistema(new Date());
            }
        }

        function handleSurplusDistribution(mode) {
            document.getElementById('modal-surplus-dist').style.display = 'none';
            const rows = Array.from(document.querySelectorAll('.fase-row'));
            
            if(mode === 'first' && rows.length > 0) {
                const inp = rows[0].querySelector('.inp-tempo');
                inp.value = parseInt(inp.value) + surplusMinutes;
            } else if (mode === 'last' && rows.length > 0) {
                const inp = rows[rows.length-1].querySelector('.inp-tempo');
                inp.value = parseInt(inp.value) + surplusMinutes;
            } else if (mode === 'all') {
                const totalDur = rows.reduce((acc, r) => acc + parseInt(r.querySelector('.inp-tempo').value)||0, 0);
                const factor = surplusMinutes / totalDur;
                rows.forEach(r => {
                    const inp = r.querySelector('.inp-tempo');
                    const v = parseInt(inp.value);
                    inp.value = Math.round(v * (1 + factor));
                });
            } else if (mode === 'flex') {
                const flexRows = rows.filter(r => r.querySelector('.inp-redutivel').checked);
                if(flexRows.length > 0) {
                    const totalDur = flexRows.reduce((acc, r) => acc + parseInt(r.querySelector('.inp-tempo').value)||0, 0);
                    const factor = surplusMinutes / totalDur;
                    flexRows.forEach(r => {
                        const inp = r.querySelector('.inp-tempo');
                        const v = parseInt(inp.value);
                        inp.value = Math.round(v * (1 + factor));
                    });
                } else { alert("Nenhuma fase flex√≠vel encontrada. Iniciando normal."); }
            }
            construirCronograma();
            rodarSistema(new Date());
        }

        function construirCronograma() {
            cronograma = [];
            document.querySelectorAll('.fase-wrapper').forEach(wrap => {
                const row = wrap.querySelector('.fase-row');
                const img = row.querySelector('.inp-img'); 
                const url = img.files[0] ? URL.createObjectURL(img.files[0]) : "";
                const customAudios = [];
                wrap.querySelectorAll('.audio-slot').forEach(slot => {
                    const f = slot.querySelector('.aud-file').files[0];
                    if(f) {
                        customAudios.push({
                            trigger: (parseInt(slot.querySelector('.aud-min').value)*60) + parseInt(slot.querySelector('.aud-sec').value),
                            src: URL.createObjectURL(f),
                            duration: parseInt(slot.querySelector('.aud-dur').value) || 0,
                            loop: slot.querySelector('.aud-loop').checked,
                            fadeIn: parseInt(slot.querySelector('.aud-fin').value) || 0,
                            fadeOut: parseInt(slot.querySelector('.aud-fout').value) || 0,
                            playThrough: slot.querySelector('.aud-playthrough').checked,
                            stopAtZero: slot.querySelector('.aud-stopzero').checked,
                            continueNext: slot.querySelector('.aud-continue').checked
                        });
                    }
                });
                cronograma.push({
                    titulo: row.querySelector('.inp-titulo').value, minutosOrig: parseFloat(row.querySelector('.inp-tempo').value),
                    segundosFinais: parseFloat(row.querySelector('.inp-tempo').value)*60, redutivel: row.querySelector('.inp-redutivel').checked,
                    intSegundos: parseInt(row.querySelector('.inp-int-tempo').value)||0, intManual: row.querySelector('.inp-int-manual').checked,
                    permitirEstouro: row.querySelector('.inp-estouro-fase').checked, beep: row.querySelector('.inp-beep-fase').checked,
                    aviso: parseInt(row.querySelector('.inp-aviso').value), bg: row.querySelector('.inp-bg').value, txt: row.querySelector('.inp-txt').value, img: url,
                    customAudios: customAudios
                });
            });
            if(cronograma.length > 0) cronograma[cronograma.length-1].permitirEstouro = true;
        }

        function rodarSistema(now) {
            document.getElementById('config-screen').style.display='none'; 
            document.getElementById('display-screen').style.display='flex';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});

            const elTit = document.getElementById('display-global-titulo');
            if(document.getElementById('chk-exibir-titulo').checked) {
                elTit.innerText = document.getElementById('global-titulo').value; elTit.style.color = document.getElementById('global-cor-titulo').value; elTit.classList.remove('hidden');
            } else elTit.classList.add('hidden');

            const hF = document.getElementById('hora-fim').value;
            const ignorarF = document.getElementById('chk-ignorar-fim').checked;

            if(ignorarF) {
                document.getElementById('lbl-fim-absoluto').innerText = "LIVRE";
                document.getElementById('lbl-fim-previsto').parentElement.style.display = 'none';
            } else {
                document.getElementById('lbl-fim-absoluto').innerText = hF;
                document.getElementById('lbl-fim-previsto').parentElement.style.display = 'flex';
                if(dataFimGlobal) {
                    const plan = cronograma.reduce((a,b)=>a+b.minutosOrig,0);
                    const disp = (dataFimGlobal - now)/60000;
                    if(plan > disp) if(!calcularAjuste(now)) return;
                }
            }

            atualizarBotoes(false); 
            indexAtual=0; rodarFase(0);
        }

        // --- CORE (Mantido) ---
        function iniciarEspera(target) {
            estado = "WAITING";
            document.getElementById('display-screen').style.display='flex';
            document.getElementById('config-screen').style.display='none';
            document.getElementById('titulo-fase').innerText = "AGUARDANDO IN√çCIO";
            document.getElementById('titulo-fase').style.color = "#00d2ff";
            document.getElementById('timer-principal').style.color = "#ffffff";
            document.getElementById('timer-principal').classList.add('timer-waiting');
            document.getElementById('display-screen').style.backgroundImage = 'none';
            document.getElementById('display-screen').style.backgroundColor = '#111';
            
            intervaloTimer = setInterval(() => {
                const now = new Date(); const diff = (target - now) / 1000;
                if (diff <= 0) { 
                    clearInterval(intervaloTimer); 
                    document.getElementById('timer-principal').classList.remove('timer-waiting');
                    tocarBip(); construirCronograma(); rodarSistema(new Date());
                } 
                else { const m = Math.floor(diff / 60); const s = Math.floor(diff % 60); document.getElementById('timer-principal').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
            }, 1000);
        }

        function playSmartAudio(config) {
            if(activeAudio) fadeAndStop(activeAudio, config.fadeIn);
            const audio = new Audio(config.src); audio.loop = config.loop; audio.volume = 0; 
            audio.play().catch(e => console.log(e));
            
            audio.customFlags = { 
                playThrough: config.playThrough, 
                stopAtZero: config.stopAtZero,
                continueNext: config.continueNext,
                srcConfig: config 
            };

            let vol = 0; const fadeInTime = config.fadeIn * 1000; const stepTime = 50; const stepVol = 1 / (fadeInTime / stepTime);
            const fadeInInterval = setInterval(() => { if(audio.volume < 1 - stepVol) audio.volume += stepVol; else { audio.volume = 1; clearInterval(fadeInInterval); } }, stepTime);
            
            if(config.duration > 0) {
                const playTime = config.duration * 1000; const fadeOutTime = config.fadeOut * 1000;
                setTimeout(() => { fadeAndStop({ el: audio }, config.fadeOut); }, playTime - fadeOutTime);
            }
            activeAudio = { el: audio };
        }

        function fadeAndStop(audioObj, durationSec) {
            if(!audioObj || !audioObj.el) return;
            const audio = audioObj.el; const fadeTime = (durationSec || 2) * 1000; const stepTime = 50; const startVol = audio.volume; const stepVol = startVol / (fadeTime / stepTime);
            const fadeOutInterval = setInterval(() => { if(audio.volume > stepVol) audio.volume -= stepVol; else { audio.volume = 0; audio.pause(); clearInterval(fadeOutInterval); if(activeAudio === audioObj) activeAudio = null; } }, stepTime);
        }

        function rodarFase(idx) {
            if(activeAudio) {
                const flags = activeAudio.el.customFlags;
                if(flags && flags.continueNext) { } else if(flags && flags.playThrough && !flags.stopAtZero) { } else { fadeAndStop(activeAudio, 2); }
            }

            indexAtual=idx; const fase=cronograma[idx]; tempoRestante=fase.segundosFinais; emIntervalo=false; estado="RODANDO";
            aplicarVisual(fase); atualizarBotoes(true);
            const btnAv = document.getElementById('btn-avancar');
            if(indexAtual >= cronograma.length - 1) btnAv.classList.add('hidden'); else btnAv.classList.remove('hidden');
            document.getElementById('lbl-fim').classList.remove('ativo', 'anim-slow', 'anim-med', 'anim-fast', 'anim-panic');
            document.getElementById('timer-principal').classList.remove('timer-waiting');
            if(intervaloTimer) clearInterval(intervaloTimer); intervaloTimer=setInterval(tick,1000); tick();
        }

        function atualizarPrevisaoEntrega() {
            if(!dataFimGlobal) return; 
            let segundosTotais = 0;
            const globalInt = document.getElementById('chk-intervalos').checked;
            if(tempoRestante > 0) segundosTotais += tempoRestante;
            for(let i = indexAtual + 1; i < cronograma.length; i++) {
                segundosTotais += cronograma[i].segundosFinais;
                if(globalInt && cronograma[i-1]) { segundosTotais += cronograma[i-1].intSegundos; }
            }
            const now = new Date();
            const previsao = new Date(now.getTime() + (segundosTotais * 1000));
            const h = String(previsao.getHours()).padStart(2,'0');
            const m = String(previsao.getMinutes()).padStart(2,'0');
            const elPrev = document.getElementById('lbl-fim-previsto');
            elPrev.innerText = `${h}:${m}`;
            if(previsao > dataFimGlobal) elPrev.style.color = "#ff4444"; else elPrev.style.color = "#28a745";
        }

        function tick() {
            if(estado!=="RODANDO" && estado!=="INTERVALO") return;
            atualizarPrevisaoEntrega();
            if(estado === "RODANDO" && !emIntervalo && document.getElementById('chk-audio-global').checked) {
                const fase = cronograma[indexAtual];
                if(fase.customAudios) { fase.customAudios.forEach(aud => { if(aud.trigger === tempoRestante) playSmartAudio(aud); }); }
            }
            if(tempoRestante === 0 && activeAudio && activeAudio.el.customFlags && activeAudio.el.customFlags.stopAtZero) { fadeAndStop(activeAudio, 2); }
            tempoRestante--;
            const abs = Math.abs(tempoRestante); const m = Math.floor(abs/60); const s = abs%60; const sinal = tempoRestante < 0 ? "-" : "";
            const el = document.getElementById('timer-principal'); el.innerText = `${sinal}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            const bg = document.getElementById('display-screen'); document.getElementById('btn-pausar').innerText = tempoRestante < 0 ? "‚è∏ PARAR" : "‚è∏ PAUSAR";
            el.classList.remove('piscando-cor', 'piscando-vermelho', 'piscando-alerta-maximo'); bg.classList.remove('bg-panic');
            if(!emIntervalo){
                if (tempoRestante > 0 && tempoRestante <= cronograma[indexAtual].aviso) el.classList.add('piscando-cor');
                else if (tempoRestante <= 0) {
                    if (tempoRestante > -180) el.classList.add('piscando-vermelho'); else el.classList.add('piscando-alerta-maximo');
                    if (tempoRestante <= -30) bg.classList.add('bg-panic');
                }
            }
            if(tempoRestante < 0) {
                if(indexAtual === cronograma.length - 1 || cronograma[indexAtual].permitirEstouro) {
                    if(intervaloTimer) clearInterval(intervaloTimer); if(tempoRestante===-1) tocarBip();
                    if(indexAtual === cronograma.length-1) gerenciarFimNaUltima(tempoRestante);
                    intervaloTimer = setInterval(tickNegativo, 1000);
                } else { clearInterval(intervaloTimer); tocarBip(); if(emIntervalo) rodarFase(indexAtual+1); else gerenciarIntervalo(); }
            }
        }

        function tickNegativo() {
            if(estado!=="RODANDO") return;
            atualizarPrevisaoEntrega();
            if(tempoRestante === 0 && document.getElementById('chk-audio-global').checked && !emIntervalo) {
                 const fase = cronograma[indexAtual];
                 if(fase.customAudios) { fase.customAudios.forEach(aud => { if(aud.trigger === 0) playSmartAudio(aud); }); }
            }
            tempoRestante--;
            const abs = Math.abs(tempoRestante); const m = Math.floor(abs/60); const s = abs%60;
            const el = document.getElementById('timer-principal'); el.innerText = `-${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            const bg = document.getElementById('display-screen');
            el.classList.remove('piscando-cor', 'piscando-vermelho', 'piscando-alerta-maximo'); bg.classList.remove('bg-panic');
            if (tempoRestante > -180) el.classList.add('piscando-vermelho'); else el.classList.add('piscando-alerta-maximo');
            if (tempoRestante <= -30) bg.classList.add('bg-panic');
            if (Math.abs(tempoRestante) % 30 === 0) tocarBip();
            if(indexAtual === cronograma.length - 1) gerenciarFimNaUltima(tempoRestante);
        }

        function gerenciarFimNaUltima(tempo) {
            const elFim = document.getElementById('lbl-fim'); elFim.style.setProperty('--txt-color', cronograma[indexAtual].txt);
            if (tempo > -120) { elFim.classList.remove('ativo'); return; }
            elFim.classList.add('ativo');
            let novaClasse = 'anim-slow';
            if (tempo <= -300) novaClasse = 'anim-panic'; else if (tempo <= -240) novaClasse = 'anim-fast'; else if (tempo <= -180) novaClasse = 'anim-med';
            if (!elFim.classList.contains(novaClasse)) { elFim.classList.remove('anim-slow', 'anim-med', 'anim-fast', 'anim-panic'); void elFim.offsetWidth; elFim.classList.add(novaClasse); }
        }

        function gerenciarIntervalo(){
            const f=cronograma[indexAtual]; if(document.getElementById('chk-intervalos').checked && indexAtual+1 < cronograma.length){
                if(f.intManual) entrarIntervaloManual(); else if(f.intSegundos>0) entrarIntervaloTempo(f.intSegundos); else rodarFase(indexAtual+1);
            } else rodarFase(indexAtual+1);
        }

        function entrarIntervaloTempo(s){ emIntervalo=true; estado="INTERVALO"; tempoRestante=s; configurarVisualIntervalo(true); intervaloTimer=setInterval(tick,1000); tick(); }
        function entrarIntervaloManual(){ emIntervalo=true; estado="PAUSADO"; atualizarBotoes(false); configurarVisualIntervalo(false); document.getElementById('btn-intervalo-manual').classList.remove('hidden'); }
        function sairIntervaloManual(){ if(calcularAjuste(new Date())){ document.getElementById('btn-intervalo-manual').classList.add('hidden'); document.getElementById('timer-principal').classList.remove('hidden'); rodarFase(indexAtual+1); }}
        function configurarVisualIntervalo(isTempo){
            const d=document.getElementById('display-screen'); d.style.backgroundImage='none'; d.style.backgroundColor='#222';
            const t=document.getElementById('titulo-fase'); t.innerText="INTERVALO"; t.style.color="#ffaa00";
            const tm=document.getElementById('timer-principal'); tm.style.color="#ffaa00"; tm.classList.remove('piscando-cor', 'piscando-vermelho', 'piscando-alerta-maximo');
            if(!isTempo) tm.classList.add('hidden');
        }
        function atualizarBotoes(rodando) { if(rodando) { document.getElementById('btn-pausar').classList.remove('hidden'); document.getElementById('btn-continuar').classList.add('hidden'); } else { document.getElementById('btn-pausar').classList.add('hidden'); document.getElementById('btn-continuar').classList.remove('hidden'); } }
        function acaoAdicionarTempo() {
            tempoRestante += 60; cronograma[indexAtual].segundosFinais += 60;
            atualizarPrevisaoEntrega(); 
            const el = document.getElementById('timer-principal'); const abs = Math.abs(tempoRestante); const m = Math.floor(abs / 60); const s = abs % 60; const sinal = tempoRestante < 0 ? "-" : ""; el.innerText = `${sinal}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if (calcularAjuste(new Date())) { if(tempoRestante > 0) { document.getElementById('lbl-fim').classList.remove('ativo'); document.getElementById('display-screen').classList.remove('bg-panic'); el.classList.remove('piscando-vermelho', 'piscando-alerta-maximo'); el.style.color = cronograma[indexAtual].txt; if(intervaloTimer) clearInterval(intervaloTimer); intervaloTimer = setInterval(tick, 1000); } }
        }
        function acaoPausar(){ 
            estado="PAUSADO"; clearInterval(intervaloTimer); 
            if(activeAudio && !activeAudio.el.paused) { document.getElementById('modal-audio-pause').style.display = 'flex'; }
            document.getElementById('timer-principal').style.opacity="0.5"; document.getElementById('display-screen').classList.remove('bg-panic'); document.getElementById('lbl-fim').style.animationPlayState = 'paused'; atualizarBotoes(false);
        }

        function resolverAudioPause(action) {
            audioResumeAction = action; document.getElementById('modal-audio-pause').style.display = 'none';
            if(!activeAudio) return;
            if(action === 'pause') { activeAudio.el.pause(); } 
            else if (action === 'restart') { activeAudio.el.pause(); activeAudio.el.currentTime = 0; } 
            else if (action === 'stop') { fadeAndStop(activeAudio, 0.5); }
        }

        function acaoContinuar(){ 
            if(estado==="PAUSADO"){ 
                if(document.getElementById('titulo-fase').innerText === "AGUARDANDO IN√çCIO") { const hI = document.getElementById('hora-inicio').value; const dIni = montarData(hI, new Date()); iniciarEspera(dIni); document.getElementById('timer-principal').style.opacity="1"; atualizarBotoes(true); return; }
                if(!document.getElementById('btn-intervalo-manual').classList.contains('hidden')) return; 
                if(activeAudio) { if(audioResumeAction === 'pause') activeAudio.el.play(); else if(audioResumeAction === 'restart') activeAudio.el.play(); } audioResumeAction = null;
                if(tempoRestante < 0 && (cronograma[indexAtual].permitirEstouro || indexAtual === cronograma.length-1)) { estado="RODANDO"; document.getElementById('timer-principal').style.opacity="1"; document.getElementById('lbl-fim').style.animationPlayState = 'running'; atualizarBotoes(true); intervaloTimer=setInterval(tickNegativo,1000); return; }
                if(!calcularAjuste(new Date())) return; 
                estado=emIntervalo?"INTERVALO":"RODANDO"; document.getElementById('timer-principal').style.opacity="1"; document.getElementById('lbl-fim').style.animationPlayState = 'running'; atualizarBotoes(true); intervaloTimer=setInterval(tick,1000); 
            }
        }
        function acaoReiniciarFase(){ 
            if(activeAudio) fadeAndStop(activeAudio, 1);
            tempoRestante=cronograma[indexAtual].segundosFinais; 
            document.getElementById('lbl-fim').classList.remove('ativo', 'anim-slow', 'anim-med', 'anim-fast', 'anim-panic'); document.getElementById('display-screen').classList.remove('bg-panic');
            const el = document.getElementById('timer-principal'); el.classList.remove('piscando-vermelho', 'piscando-cor', 'piscando-alerta-maximo'); el.style.color = cronograma[indexAtual].txt;
            if(calcularAjuste(new Date())){ const m=Math.floor(tempoRestante/60), s=tempoRestante%60; el.innerText=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(estado!=="RODANDO") acaoContinuar(); }
        }
        function acaoAvan√ßar(){ 
            if(estado === "WAITING" || document.getElementById('titulo-fase').innerText === "AGUARDANDO IN√çCIO") { document.getElementById('timer-principal').classList.remove('timer-waiting'); clearInterval(intervaloTimer); indexAtual = 0; rodarFase(0); } else { if(indexAtual < cronograma.length - 1) rodarFase(indexAtual + 1); }
        }
        function calcularAjuste(now){
            if(!dataFimGlobal) return true; 
            if(indexAtual>=cronograma.length-1) return true;
            const disp=(dataFimGlobal-now)/1000; if(disp<=0){ abrirModal(); return false; }
            let nec=tempoRestante; for(let i=indexAtual+1; i<cronograma.length; i++) nec+=cronograma[i].segundosFinais; if(nec<=disp+5) return true;
            let pool=0, idxs=[]; if(cronograma[indexAtual].redutivel && (estado==="RODANDO"||estado==="PAUSADO")){ pool+=tempoRestante; idxs.push(indexAtual); }
            for(let i=indexAtual+1; i<cronograma.length; i++){ if(cronograma[i].redutivel){ pool+=cronograma[i].minutosOrig*60; idxs.push(i); }}
            let fixo=nec-pool, sobra=disp-fixo; if(sobra<=0 || idxs.length===0){ abrirModal(); return false; }
            const fator=sobra/pool;
            idxs.forEach(i=>{ if(i===indexAtual) tempoRestante=Math.floor(tempoRestante*fator); else cronograma[i].segundosFinais=Math.floor(cronograma[i].minutosOrig*60*fator); });
            notificarAjuste(`‚ö†Ô∏è Ajuste (-${((1-fator)*100).toFixed(0)}%)`); return true;
        }
        function abrirModal(){ document.getElementById('modal-decisao').style.display='flex'; }
        function resolverConflito(opt){
            document.getElementById('modal-decisao').style.display='none';
            if(opt===1){ for(let i=indexAtual; i<cronograma.length; i++) cronograma[i].redutivel=true; if(calcularAjuste(new Date())) acaoContinuar(); }
            if(opt===2){ for(let i=indexAtual; i<cronograma.length-1; i++) cronograma[i].redutivel=false; cronograma[cronograma.length-1].redutivel=true; if(calcularAjuste(new Date())) acaoContinuar(); }
            if(opt===3){ notificarAjuste("‚ö†Ô∏è Prazo Ignorado"); dataFimGlobal = null; if(!document.getElementById('btn-intervalo-manual').classList.contains('hidden')) sairIntervaloManual(); else acaoContinuar(); }
            if(opt===4){ const n=prompt("Novo hor√°rio (HH:MM):", document.getElementById('hora-fim').value); if(n){ dataFimGlobal=montarData(n,new Date()); if(dataFimGlobal<new Date()) dataFimGlobal.setDate(dataFimGlobal.getDate()+1); if(calcularAjuste(new Date())) acaoContinuar(); } else abrirModal(); }
        }
        function aplicarVisual(f){
            const el=document.getElementById('display-screen'); el.style.backgroundColor=f.bg; el.style.backgroundImage=f.img?`url('${f.img}')`:'none'; el.classList.remove('bg-panic');
            document.getElementById('btn-intervalo-manual').classList.add('hidden'); document.getElementById('timer-principal').classList.remove('hidden');
            document.getElementById('titulo-fase').innerText=f.titulo; document.getElementById('titulo-fase').style.color=f.txt;
            const tm = document.getElementById('timer-principal'); tm.style.color=f.txt; tm.style.setProperty('--txt-color', f.txt); 
            document.getElementById('txt-status').style.color=f.txt; const p=document.getElementById('txt-proximo'); p.style.color=f.txt; p.innerText=`Pr√≥ximo: ${(indexAtual+1<cronograma.length)?cronograma[indexAtual+1].titulo:"Fim"}`;
        }
        function montarData(s,ref){ const [h,m]=s.split(':'); const d=new Date(ref); d.setHours(parseInt(h),parseInt(m),0,0); return d; }
        function notificarAjuste(m){ const el=document.getElementById('txt-status'); el.innerText=m; el.style.color="#ffaa00"; }
        function tocarBip(){ 
            const globalAudio = document.getElementById('chk-audio-global').checked; const faseBeep = cronograma[indexAtual].beep; if(!globalAudio || !faseBeep) return;
            try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); o.type='sine'; o.frequency.value=880; o.connect(c.destination); o.start(); o.stop(c.currentTime+0.5); }catch(e){} 
        }
        function encerrar(){ 
            if(intervaloTimer) clearInterval(intervaloTimer); if(activeAudio) fadeAndStop(activeAudio, 1);
            document.getElementById('display-screen').style.display = 'none'; document.getElementById('config-screen').style.display = 'block'; 
            const d=document.getElementById('display-screen'); d.style.background="#000"; d.style.backgroundImage='none'; d.classList.remove('bg-panic');
            document.getElementById('titulo-fase').innerText="..."; document.getElementById('lbl-fim').classList.remove('ativo', 'anim-slow', 'anim-med', 'anim-fast', 'anim-panic');
            document.getElementById('timer-principal').innerText="00:00"; document.getElementById('timer-principal').classList.remove('piscando-cor', 'piscando-vermelho', 'piscando-alerta-maximo');
            document.getElementById('btn-intervalo-manual').classList.add('hidden'); document.getElementById('timer-principal').classList.remove('hidden');
        }

        // --- INICIALIZA√á√ÉO SEGURA (NO FINAL) ---
        window.onload = function() {
            try {
                document.getElementById('global-cor-titulo').addEventListener('input', e => document.getElementById('global-titulo').style.color = e.target.value);
                
                // Configura√ß√£o Inicial de Data
                const now = new Date(); 
                const stdStart = new Date(now); stdStart.setHours(9,20,0,0);
                let sVal="09:20", eVal="10:15";
                if(now > stdStart){
                    const h=String(now.getHours()).padStart(2,'0'), m=String(now.getMinutes()).padStart(2,'0'); sVal = `${h}:${m}`;
                    const endD = new Date(now.getTime() + 55*60000); eVal = `${String(endD.getHours()).padStart(2,'0')}:${String(endD.getMinutes()).padStart(2,'0')}`;
                }
                document.getElementById('hora-inicio').value = sVal; document.getElementById('hora-fim').value = eVal;
                
                // Adicionar Fases Iniciais Padr√£o
                adicionarFase("Confraterniza√ß√£o", 10, true, "#ffcc00", "#ffffff");
                adicionarFase("Miss√£o", 15, true, "#28a745", "#ffffff");
                adicionarFase("Estudo da B√≠blia e Ora√ß√£o", 30, false, "#007bff", "#ffffff");
                
                // Rel√≥gio Real
                setInterval(()=>{ document.getElementById('relogio-real').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); },1000);

            } catch (err) {
                alert("Erro Fatal ao carregar o sistema: " + err.message);
                console.error(err);
            }
        };
    </script>
</body>
</html>