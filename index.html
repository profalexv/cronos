<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>cronos@alexandre.pro.br v1.32</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; height: 100vh; overflow: hidden; cursor: default; }
        
        /* --- CONFIGURA√á√ÉO --- */
        #config-screen { padding: 20px; height: 100vh; overflow-y: auto; box-sizing: border-box; max-width: 1200px; margin: 0 auto; }
        
        .painel-top { 
            background: #1e1e1e; padding: 15px; border-radius: 8px; border-left: 5px solid #00d2ff; 
            margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; 
        }
        .campo { display: flex; flex-direction: column; }
        .campo label { font-size: 0.8rem; color: #bbb; margin-bottom: 5px; }
        
        input, select { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; }
        
        /* Input de T√≠tulo Global */
        #global-titulo {
            background: transparent; border: none; font-size: 1.8rem; font-weight: bold; 
            color: #00d2ff; width: 100%; padding: 5px; margin: 0;
        }
        #global-titulo:focus { outline: 1px dashed #555; background: rgba(255,255,255,0.05); }

        /* Bot√µes de Arquivo */
        .btn-file { background: #444; border: 1px solid #666; color: #fff; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-file:hover { background: #555; border-color: #888; }

        /* Inputs de Cor */
        input[type="color"] {
            -webkit-appearance: none; border: 1px solid #555; width: 50px; height: 40px; padding: 0;
            background: none; cursor: pointer; border-radius: 4px; overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
        
        /* Lista de Fases */
        .fase-row { 
            background: #252526; border: 1px solid #444; padding: 10px; margin-bottom: 10px; 
            border-radius: 6px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; 
        }
        
        .col-intervalo { background: rgba(255, 170, 0, 0.15); padding: 5px; border-radius: 4px; display: flex; gap: 5px; border: 1px dashed #666; }
        .hidden { display: none !important; }

        #lista-fases .fase-row:last-child .col-intervalo { visibility: hidden; pointer-events: none; }

        /* Bot√µes A√ß√£o */
        .btn-x { background: #ff4444; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .btn-add { background: #444; color: white; border: 1px solid #666; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn-go { background: linear-gradient(135deg, #00d2ff, #0072ff); color: white; border: none; padding: 15px; flex-grow: 1; font-weight: bold; font-size: 1.1rem; border-radius: 4px; cursor: pointer; }

        /* --- APRESENTA√á√ÉO --- */
        #display-screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; background-color: #000; background-size: cover; background-position: center; position: relative; transition: background-color 0.5s; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1; }
        
        #relogio-real { position: absolute; top: 15px; right: 20px; z-index: 20; font-size: 1.5rem; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; border: 1px solid #444; }
        #btn-sair { position: absolute; top: 15px; left: 20px; z-index: 20; background: none; border: none; color: #555; font-size: 1.2rem; cursor: pointer; }

        .conteudo-box { z-index: 10; text-align: center; padding: 40px; border-radius: 20px; background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(5px); min-width: 60%; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #titulo-fase { font-size: 2.5rem; margin: 0; text-transform: uppercase; color: #fff; letter-spacing: 2px; }
        #timer-principal { font-size: 9rem; margin: 0; font-weight: bold; line-height: 1; font-variant-numeric: tabular-nums; }
        #rodape-info { margin-top: 15px; font-size: 1.2rem; color: #aaa; border-top: 1px solid #555; padding-top: 10px; display: flex; justify-content: space-between;}

        /* Controles Playback */
        .controles-play { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-ctrl { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; min-width: 100px; transition: background 0.2s;}
        .btn-ctrl:hover { background: rgba(255,255,255,0.2); }
        
        .btn-proximo { background: #ffaa00; color: #000; font-weight: bold; font-size: 1.5rem; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; margin-top: 20px; }

        /* Modal */
        #modal-decisao { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: #222; padding: 30px; border-radius: 10px; border: 1px solid #ff4444; max-width: 500px; text-align: center; }
        .modal-opts { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 15px; border: none; background: #333; color: white; text-align: left; cursor: pointer; border-radius: 4px; }
        .btn-modal:hover { background: #444; }

        /* TOOLTIP */
        #custom-tooltip {
            position: fixed; background: rgba(0, 0, 0, 0.95); border: 1px solid #00d2ff; color: #fff;
            padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; pointer-events: none; z-index: 9999;
            display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.8); max-width: 250px; line-height: 1.4;
        }

        /* Anima√ß√µes */
        .piscando { color: #ff4444 !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.02); text-shadow: 0 0 20px red; } 100% { transform: scale(1); } }
        
        /* Piscar Fundo Cr√≠tico */
        .bg-panic { animation: bg-flash 1s infinite; }
        @keyframes bg-flash { 
            0% { background-color: #300000; } 
            50% { background-color: #aa0000; } 
            100% { background-color: #300000; } 
        }
    </style>
</head>
<body>

    <div id="custom-tooltip"></div>
    <input type="file" id="file-input" style="display: none;" accept=".json" onchange="carregarArquivo(this)">

    <div id="config-screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px; flex-grow:1; margin-right:20px;">
                <input type="text" id="global-titulo" value="Escola Sabatina Viva" data-tooltip="Clique para editar o t√≠tulo do evento.">
                <input type="color" id="global-cor-titulo" value="#00d2ff" style="width:40px; height:35px; border:none;" data-tooltip="Alterar cor do t√≠tulo.">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-file" onclick="salvarConfiguracao()" data-tooltip="Salvar a programa√ß√£o com o nome do t√≠tulo.">üíæ Salvar</button>
                <button class="btn-file" onclick="document.getElementById('file-input').click()" data-tooltip="Carregar uma programa√ß√£o salva.">üìÇ Abrir</button>
            </div>
        </div>
        
        <div class="painel-top">
            <div class="campo" data-tooltip="In√≠cio da programa√ß√£o.">
                <label>In√≠cio Planejado</label>
                <input type="time" id="hora-inicio">
            </div>
            <div class="campo" data-tooltip="Hor√°rio limite para encerramento.">
                <label>Fim Absoluto</label>
                <input type="time" id="hora-fim">
            </div>
            <div class="campo" style="flex-direction: row; align-items: center; gap: 10px; padding-bottom: 5px;" data-tooltip="Habilita pausas entre as partes.">
                <input type="checkbox" id="chk-intervalos" onchange="toggleIntervalosGlobais()" style="width:20px; height:20px;">
                <label style="margin:0; cursor:pointer;" for="chk-intervalos">Habilitar Intervalos</label>
            </div>
        </div>

        <div id="lista-fases"></div>

        <div style="display:flex; gap:15px; margin-top:20px; padding-bottom:50px;">
            <button class="btn-add" onclick="adicionarFase()" data-tooltip="Adiciona nova linha.">+ Nova Etapa</button>
            <button class="btn-go" onclick="iniciarApresentacao()" data-tooltip="Inicia o cron√¥metro em tela cheia.">INICIAR ‚ñ∑</button>
        </div>
    </div>

    <div id="display-screen">
        <button id="btn-sair" onclick="encerrar()" title="Sair" data-tooltip="Sair para configura√ß√£o">‚úï</button>
        <div class="overlay"></div>
        <div id="relogio-real" data-tooltip="Hora Atual">--:--</div>

        <div class="conteudo-box" id="box-principal">
            <h2 id="titulo-fase">...</h2>
            <div id="area-timer" data-tooltip="Tempo restante">
                <div id="timer-principal">00:00</div>
            </div>
            <button id="btn-intervalo-manual" class="btn-proximo hidden" onclick="sairIntervaloManual()" data-tooltip="Iniciar pr√≥xima parte">INICIAR PR√ìXIMA PARTE ‚ñ∂</button>

            <div id="rodape-info">
                <span id="txt-status" style="color:#00d2ff;">Tempo Normal</span>
                <span id="txt-proximo">Pr√≥ximo: ...</span>
            </div>

            <div class="controles-play">
                <button id="btn-pausar" class="btn-ctrl" onclick="acaoPausar()" data-tooltip="Pausar cron√¥metro (ou parar tempo negativo)">‚è∏ Pausar/Parar</button>
                <button id="btn-continuar" class="btn-ctrl hidden" onclick="acaoContinuar()" data-tooltip="Continuar contagem">‚ñ∂ Continuar</button>
                <button class="btn-ctrl" onclick="acaoReiniciarFase()" style="border-color:#ffaa00; color:#ffaa00;" data-tooltip="Reiniciar etapa atual">‚Ü∫ Reiniciar Fase</button>
                <button class="btn-ctrl" onclick="acaoAvan√ßar()" style="border-color:#00d2ff; color:#00d2ff;" data-tooltip="Pular para a pr√≥xima etapa (ignora espera).">‚è≠ Avan√ßar</button>
                <button class="btn-ctrl" onclick="encerrar()" style="border-color:#ff4444; color:#ff4444;" data-tooltip="Voltar ao menu de configura√ß√£o.">‚èπ Encerrar</button>
            </div>
        </div>
    </div>

    <div id="modal-decisao">
        <div class="modal-box">
            <h2 style="color:#ff4444; margin-top:0;">‚ö†Ô∏è Atraso Cr√≠tico</h2>
            <p>O tempo acabou. Como deseja proceder?</p>
            <div class="modal-opts">
                <button class="btn-modal" onclick="resolverConflito(1)"><b>1. Reduzir Todas</b></button>
                <button class="btn-modal" onclick="resolverConflito(2)"><b>2. Reduzir √öltima</b></button>
                <button class="btn-modal" onclick="resolverConflito(3)"><b>3. Ignorar Prazo</b></button>
                <button class="btn-modal" onclick="resolverConflito(4)"><b>4. Alterar Hor√°rio Final</b></button>
            </div>
        </div>
    </div>

    <script>
        // --- EVENTOS UI ---
        document.getElementById('global-cor-titulo').addEventListener('input', e => document.getElementById('global-titulo').style.color = e.target.value);

        // --- SISTEMA DE ARQUIVOS ---
        function salvarConfiguracao() {
            const titulo = document.getElementById('global-titulo').value || "Cronograma";
            // Sanitiza o nome do arquivo
            const nomeArquivo = titulo.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";

            const dados = { 
                tituloGlobal: titulo, corGlobal: document.getElementById('global-cor-titulo').value,
                inicio: document.getElementById('hora-inicio').value, fim: document.getElementById('hora-fim').value, 
                intervalosAtivos: document.getElementById('chk-intervalos').checked, fases: [] 
            };
            document.querySelectorAll('.fase-row').forEach(row => {
                dados.fases.push({
                    titulo: row.querySelector('.inp-titulo').value, minutos: row.querySelector('.inp-tempo').value, redutivel: row.querySelector('.inp-redutivel').checked,
                    intTempo: row.querySelector('.inp-int-tempo').value, intManual: row.querySelector('.inp-int-manual').checked, aviso: row.querySelector('.inp-aviso').value,
                    bg: row.querySelector('.inp-bg').value, txt: row.querySelector('.inp-txt').value
                });
            });
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = nomeArquivo;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function carregarArquivo(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => { try { aplicarConfiguracao(JSON.parse(e.target.result)); } catch(err){ alert("Erro: "+err.message); }};
            r.readAsText(f); input.value = "";
        }

        function aplicarConfiguracao(d) {
            if(d.tituloGlobal) { document.getElementById('global-titulo').value = d.tituloGlobal; document.getElementById('global-cor-titulo').value = d.corGlobal || "#00d2ff"; document.getElementById('global-titulo').style.color = d.corGlobal || "#00d2ff"; }
            document.getElementById('hora-inicio').value = d.inicio; document.getElementById('hora-fim').value = d.fim;
            document.getElementById('chk-intervalos').checked = d.intervalosAtivos; toggleIntervalosGlobais();
            document.getElementById('lista-fases').innerHTML = "";
            d.fases.forEach(f => {
                adicionarFase(f.titulo, f.minutos, f.redutivel, f.bg, f.txt);
                const l = document.querySelectorAll('.fase-row'); const last = l[l.length-1];
                if(last){ last.querySelector('.inp-int-tempo').value=f.intTempo; last.querySelector('.inp-int-manual').checked=f.intManual; last.querySelector('.inp-aviso').value=f.aviso; }
            });
            alert("Configura√ß√£o carregada! (Nota: Selecione as imagens novamente)");
        }

        // --- TOOLTIPS ---
        const tooltip = document.getElementById('custom-tooltip');
        let tooltipTimeout;
        document.addEventListener('mousemove', e => { if(tooltip.style.display==='block'){ tooltip.style.top=(e.clientY+15)+'px'; tooltip.style.left=(e.clientX+15)+'px'; }});
        document.addEventListener('mouseover', e => { const t = e.target.closest('[data-tooltip]'); if(t){ tooltipTimeout = setTimeout(()=>{ tooltip.innerText=t.getAttribute('data-tooltip'); tooltip.style.top=(e.clientY+15)+'px'; tooltip.style.left=(e.clientX+15)+'px'; tooltip.style.display='block'; }, 3000); }});
        document.addEventListener('mouseout', e => { const t=e.target.closest('[data-tooltip]'); if(t){ clearTimeout(tooltipTimeout); tooltip.style.display='none'; }});

        // --- CORE ---
        let cronograma=[], indexAtual=0, tempoRestante=0, estado="PARADO", intervaloTimer=null, dataFimGlobal=null, emIntervalo=false;

        window.onload = function() {
            const now = new Date(); const stdStart = new Date(now); stdStart.setHours(9,20,0,0);
            let sVal="09:20", eVal="10:15";
            if(now > stdStart){
                const h=String(now.getHours()).padStart(2,'0'), m=String(now.getMinutes()).padStart(2,'0'); sVal = `${h}:${m}`;
                const endD = new Date(now.getTime() + 55*60000); eVal = `${String(endD.getHours()).padStart(2,'0')}:${String(endD.getMinutes()).padStart(2,'0')}`;
            }
            document.getElementById('hora-inicio').value = sVal; document.getElementById('hora-fim').value = eVal;
            adicionarFase("Confraterniza√ß√£o", 10, true, "#ffcc00", "#ffffff");
            adicionarFase("Miss√£o", 15, true, "#28a745", "#ffffff");
            adicionarFase("Estudo da B√≠blia e Ora√ß√£o", 30, false, "#007bff", "#ffffff");
            setInterval(()=>{ document.getElementById('relogio-real').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); },1000);
        };

        function toggleIntervalosGlobais(){ const c = document.getElementById('chk-intervalos').checked; document.querySelectorAll('.col-intervalo').forEach(e => c ? e.classList.remove('hidden') : e.classList.add('hidden')); }

        let idCount=0;
        function adicionarFase(tit="", min=10, red=true, bg="#000000", txt="#ffffff") {
            idCount++; const c = document.getElementById('lista-fases');
            const hide = document.getElementById('chk-intervalos').checked ? '' : 'hidden';
            const div = document.createElement('div'); div.className = 'fase-row';
            div.innerHTML = `
                <button class="btn-x" onclick="this.parentElement.remove()" data-tooltip="Remover">X</button>
                <div class="campo" style="flex:2; min-width:150px;" data-tooltip="Nome da parte"><label>T√≠tulo</label><input type="text" class="inp-titulo" value="${tit}"></div>
                <div class="campo" style="width:70px;" data-tooltip="Dura√ß√£o (min)"><label>Min</label><input type="number" class="inp-tempo" value="${min}" min="1"></div>
                <div class="campo" style="align-items:center;" data-tooltip="Redut√≠vel?"><label>Redut?</label><input type="checkbox" class="inp-redutivel" ${red?'checked':''} style="width:20px; height:20px;"></div>
                <div class="col-intervalo ${hide}">
                    <div class="campo" style="width:60px;" data-tooltip="Intervalo (s)"><label>Pausa</label><input type="number" class="inp-int-tempo" value="30"></div>
                    <div class="campo" style="align-items:center;" data-tooltip="Esperar clique?"><label>Clique?</label><input type="checkbox" class="inp-int-manual" style="width:20px; height:20px;"></div>
                </div>
                <div class="campo" style="width:60px;" data-tooltip="Aviso (s)"><label>Aviso</label><input type="number" class="inp-aviso" value="30"></div>
                <div class="campo" data-tooltip="Cor Fundo"><label>Bg</label><input type="color" class="inp-bg" value="${bg}"></div>
                <div class="campo" data-tooltip="Cor Texto"><label>Txt</label><input type="color" class="inp-txt" value="${txt}"></div>
                <div class="campo" style="flex:1;" data-tooltip="Imagem"><label>Img</label><input type="file" class="inp-img" accept="image/*"></div>
            `;
            c.appendChild(div);
        }

        function iniciarApresentacao() {
            const hI = document.getElementById('hora-inicio').value, hF = document.getElementById('hora-fim').value;
            const rows = document.querySelectorAll('.fase-row');
            if(!hI || !hF || rows.length===0) return alert("Configure os dados.");
            const now = new Date(); const dIni = montarData(hI, now);
            dataFimGlobal = montarData(hF, now); if(dataFimGlobal < dIni) dataFimGlobal.setDate(dataFimGlobal.getDate()+1);
            cronograma = [];
            rows.forEach(r => {
                const img = r.querySelector('.inp-img'); const url = img.files[0] ? URL.createObjectURL(img.files[0]) : "";
                cronograma.push({
                    titulo: r.querySelector('.inp-titulo').value, minutosOrig: parseFloat(r.querySelector('.inp-tempo').value),
                    segundosFinais: parseFloat(r.querySelector('.inp-tempo').value)*60, redutivel: r.querySelector('.inp-redutivel').checked,
                    intSegundos: parseInt(r.querySelector('.inp-int-tempo').value)||0, intManual: r.querySelector('.inp-int-manual').checked,
                    aviso: parseInt(r.querySelector('.inp-aviso').value), bg: r.querySelector('.inp-bg').value, txt: r.querySelector('.inp-txt').value, img: url
                });
            });

            document.getElementById('config-screen').style.display='none'; 
            document.getElementById('display-screen').style.display='flex';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});

            atualizarBotoes(false); // Play visivel, Pause oculto

            if(now < dIni) iniciarEspera(dIni);
            else {
                const plan = cronograma.reduce((a,b)=>a+b.minutosOrig,0); const disp = (dataFimGlobal - now)/60000;
                if(plan > disp) if(!calcularAjuste(now)) return;
                indexAtual=0; rodarFase(0);
            }
        }

        function iniciarEspera(target) {
            estado = "WAITING";
            document.getElementById('titulo-fase').innerText = "AGUARDANDO IN√çCIO";
            document.getElementById('titulo-fase').style.color = "#00d2ff";
            document.getElementById('timer-principal').style.color = "#ffffff";
            document.getElementById('display-screen').style.backgroundImage = 'none';
            document.getElementById('display-screen').style.backgroundColor = '#111';
            
            intervaloTimer = setInterval(() => {
                const now = new Date(); const diff = (target - now) / 1000;
                if (diff <= 0) {
                    clearInterval(intervaloTimer); tocarBip();
                    if(calcularAjuste(new Date())) { indexAtual = 0; rodarFase(0); }
                } else {
                    const m = Math.floor(diff / 60); const s = Math.floor(diff % 60);
                    document.getElementById('timer-principal').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }
            }, 1000);
        }

        function rodarFase(idx){
            indexAtual=idx; const fase=cronograma[idx]; tempoRestante=fase.segundosFinais; emIntervalo=false; estado="RODANDO";
            aplicarVisual(fase);
            atualizarBotoes(true);
            if(intervaloTimer) clearInterval(intervaloTimer); intervaloTimer=setInterval(tick,1000); tick();
        }

        function tick(){
            if(estado!=="RODANDO" && estado!=="INTERVALO") return;
            tempoRestante--;
            
            // Logica Visual de Tempo (Suporta negativo)
            const abs = Math.abs(tempoRestante);
            const m = Math.floor(abs / 60); const s = abs % 60;
            const sinal = tempoRestante < 0 ? "-" : "";
            const el = document.getElementById('timer-principal');
            el.innerText = `${sinal}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

            // Logica de Alerta
            const bg = document.getElementById('display-screen');
            if(!emIntervalo){
                if(tempoRestante <= cronograma[indexAtual].aviso && tempoRestante > -30) {
                    el.classList.add('piscando'); bg.classList.remove('bg-panic');
                } else if(tempoRestante <= -30) {
                    el.classList.add('piscando'); bg.classList.add('bg-panic');
                } else {
                    el.classList.remove('piscando'); bg.classList.remove('bg-panic');
                }
            }

            // Logica de Troca
            if(tempoRestante < 0) {
                // Se N√ÉO for a √∫ltima, troca. Se for a √∫ltima, continua contando negativo.
                if(indexAtual < cronograma.length - 1) {
                    clearInterval(intervaloTimer); tocarBip();
                    if(emIntervalo) rodarFase(indexAtual+1); else gerenciarIntervalo();
                } else {
                    // √öltima fase estourada -> Apenas visual (j√° tratado acima)
                }
            }
        }

        function gerenciarIntervalo(){
            const f=cronograma[indexAtual]; const chk=document.getElementById('chk-intervalos').checked;
            if(chk && indexAtual+1 < cronograma.length){
                if(f.intManual) entrarIntervaloManual(); else if(f.intSegundos>0) entrarIntervaloTempo(f.intSegundos); else rodarFase(indexAtual+1);
            } else rodarFase(indexAtual+1);
        }

        function entrarIntervaloTempo(s){ emIntervalo=true; estado="INTERVALO"; tempoRestante=s; configurarVisualIntervalo(true); intervaloTimer=setInterval(tick,1000); tick(); }
        function entrarIntervaloManual(){ emIntervalo=true; estado="PAUSADO"; atualizarBotoes(false); configurarVisualIntervalo(false); document.getElementById('btn-intervalo-manual').classList.remove('hidden'); }
        function sairIntervaloManual(){ if(calcularAjuste(new Date())){ document.getElementById('btn-intervalo-manual').classList.add('hidden'); document.getElementById('timer-principal').classList.remove('hidden'); rodarFase(indexAtual+1); }}
        
        function configurarVisualIntervalo(isTempo){
            const d=document.getElementById('display-screen'); d.style.backgroundImage='none'; d.style.backgroundColor='#222';
            const t=document.getElementById('titulo-fase'); t.innerText="INTERVALO"; t.style.color="#ffaa00";
            const tm=document.getElementById('timer-principal'); tm.style.color="#ffaa00"; tm.classList.remove('piscando');
            if(!isTempo) tm.classList.add('hidden');
        }

        function atualizarBotoes(rodando) {
            if(rodando) {
                document.getElementById('btn-pausar').classList.remove('hidden');
                document.getElementById('btn-continuar').classList.add('hidden');
            } else {
                document.getElementById('btn-pausar').classList.add('hidden');
                document.getElementById('btn-continuar').classList.remove('hidden');
            }
        }

        function acaoPausar(){ 
            // Pausa ou Para o contador negativo
            estado="PAUSADO"; clearInterval(intervaloTimer); 
            document.getElementById('timer-principal').style.opacity="0.5";
            document.getElementById('display-screen').classList.remove('bg-panic'); // Para o piscar fundo se houver
            atualizarBotoes(false);
        }
        
        function acaoContinuar(){ 
            if(estado==="PAUSADO"){ 
                if(document.getElementById('titulo-fase').innerText === "AGUARDANDO IN√çCIO") {
                    const hI = document.getElementById('hora-inicio').value;
                    const dIni = montarData(hI, new Date());
                    iniciarEspera(dIni);
                    document.getElementById('timer-principal').style.opacity="1";
                    atualizarBotoes(true);
                    return;
                }
                if(!document.getElementById('btn-intervalo-manual').classList.contains('hidden')) return; 
                
                // Se j√° estamos em tempo negativo, n√£o calcula ajuste, apenas roda
                if(tempoRestante >= 0 && !calcularAjuste(new Date())) return; 
                
                estado=emIntervalo?"INTERVALO":"RODANDO"; 
                document.getElementById('timer-principal').style.opacity="1"; 
                atualizarBotoes(true);
                intervaloTimer=setInterval(tick,1000); 
            }
        }
        
        function acaoReiniciarFase(){ tempoRestante=cronograma[indexAtual].segundosFinais; if(calcularAjuste(new Date())){ const m=Math.floor(tempoRestante/60), s=tempoRestante%60; document.getElementById('timer-principal').innerText=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(estado!=="RODANDO") acaoContinuar(); }}
        
        function acaoAvan√ßar(){ 
            if(estado === "WAITING" || document.getElementById('titulo-fase').innerText === "AGUARDANDO IN√çCIO") {
                clearInterval(intervaloTimer); indexAtual = 0; rodarFase(0);
            } else {
                if(indexAtual < cronograma.length - 1) rodarFase(indexAtual + 1); 
                else encerrar();
            }
        }

        function calcularAjuste(now){
            if(indexAtual>=cronograma.length-1) return true;
            const disp=(dataFimGlobal-now)/1000; if(disp<=0){ abrirModal(); return false; }
            let nec=tempoRestante; for(let i=indexAtual+1; i<cronograma.length; i++) nec+=cronograma[i].segundosFinais;
            if(nec<=disp+5) return true;
            let pool=0, idxs=[];
            if(cronograma[indexAtual].redutivel && (estado==="RODANDO"||estado==="PAUSADO")){ pool+=tempoRestante; idxs.push(indexAtual); }
            for(let i=indexAtual+1; i<cronograma.length; i++){ if(cronograma[i].redutivel){ pool+=cronograma[i].minutosOrig*60; idxs.push(i); }}
            let fixo=nec-pool, sobra=disp-fixo; if(sobra<=0 || idxs.length===0){ abrirModal(); return false; }
            const fator=sobra/pool;
            idxs.forEach(i=>{ if(i===indexAtual) tempoRestante=Math.floor(tempoRestante*fator); else cronograma[i].segundosFinais=Math.floor(cronograma[i].minutosOrig*60*fator); });
            notificarAjuste(`‚ö†Ô∏è Ajuste (-${((1-fator)*100).toFixed(0)}%)`); return true;
        }

        function abrirModal(){ document.getElementById('modal-decisao').style.display='flex'; }
        function resolverConflito(opt){
            document.getElementById('modal-decisao').style.display='none';
            if(opt===1){ for(let i=indexAtual; i<cronograma.length; i++) cronograma[i].redutivel=true; if(calcularAjuste(new Date())) acaoContinuar(); }
            if(opt===2){ for(let i=indexAtual; i<cronograma.length-1; i++) cronograma[i].redutivel=false; cronograma[cronograma.length-1].redutivel=true; if(calcularAjuste(new Date())) acaoContinuar(); }
            if(opt===3){ notificarAjuste("‚ö†Ô∏è Prazo Ignorado"); if(!document.getElementById('btn-intervalo-manual').classList.contains('hidden')) sairIntervaloManual(); else acaoContinuar(); }
            if(opt===4){ const n=prompt("Novo hor√°rio (HH:MM):", document.getElementById('hora-fim').value); if(n){ dataFimGlobal=montarData(n,new Date()); if(dataFimGlobal<new Date()) dataFimGlobal.setDate(dataFimGlobal.getDate()+1); if(calcularAjuste(new Date())) acaoContinuar(); } else abrirModal(); }
        }

        function aplicarVisual(f){
            const el=document.getElementById('display-screen'); el.style.backgroundColor=f.bg; el.style.backgroundImage=f.img?`url('${f.img}')`:'none'; el.classList.remove('bg-panic');
            document.getElementById('btn-intervalo-manual').classList.add('hidden');
            document.getElementById('timer-principal').classList.remove('hidden');
            document.getElementById('titulo-fase').innerText=f.titulo; document.getElementById('titulo-fase').style.color=f.txt;
            document.getElementById('timer-principal').style.color=f.txt;
            document.getElementById('txt-status').style.color=f.txt;
            const p=document.getElementById('txt-proximo'); p.style.color=f.txt;
            p.innerText=`Pr√≥ximo: ${(indexAtual+1<cronograma.length)?cronograma[indexAtual+1].titulo:"Fim"}`;
        }

        function montarData(s,ref){ const [h,m]=s.split(':'); const d=new Date(ref); d.setHours(parseInt(h),parseInt(m),0,0); return d; }
        function notificarAjuste(m){ const el=document.getElementById('txt-status'); el.innerText=m; el.style.color="#ffaa00"; }
        function tocarBip(){ try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); o.type='sine'; o.frequency.value=880; o.connect(c.destination); o.start(); o.stop(c.currentTime+0.5); }catch(e){} }
        function encerrar(){ 
            if(intervaloTimer) clearInterval(intervaloTimer);
            document.getElementById('display-screen').style.display = 'none'; // Volta para config
            document.getElementById('config-screen').style.display = 'block'; // Mostra config
            
            // Reseta visual da tela de display para quando abrir de novo
            const d=document.getElementById('display-screen'); 
            d.style.background="#000"; d.style.backgroundImage='none'; d.classList.remove('bg-panic');
            document.getElementById('titulo-fase').innerText="..."; 
            document.getElementById('timer-principal').innerText="00:00"; 
            document.getElementById('btn-intervalo-manual').classList.add('hidden');
            document.getElementById('timer-principal').classList.remove('hidden');
        }
    </script>
</body>
</html>
