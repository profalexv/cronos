<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cronos v1.363 - Vers√£o Completa</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        :root { --accent: #00d2ff; --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --success: #28a745; --warning: #ffaa00; --danger: #ff4444; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; cursor: default; }
        
        /* --- CONFIGURA√á√ÉO --- */
        #config-screen { padding: 20px; height: 100vh; overflow-y: auto; box-sizing: border-box; max-width: 1200px; margin: 0 auto; }
        
        .painel-top { background: var(--panel); padding: 15px; border-radius: 8px; border-left: 5px solid var(--accent); margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .campo { display: flex; flex-direction: column; }
        .campo label { font-size: 0.8rem; color: #bbb; margin-bottom: 5px; }
        
        input, select { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; transition: border 0.2s; }
        input:focus { border-color: var(--accent); outline: none; }
        input:disabled { background: #222; color: #555; border-color: #333; cursor: not-allowed; opacity: 0.5; }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .time-group { display: flex; align-items: center; gap: 5px; }
        .btn-small { background: #444; border: 1px solid #666; color: #fff; width: 30px; height: 35px; border-radius: 4px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; padding: 0; transition: 0.2s; }
        .btn-small:hover:not(:disabled) { background: var(--accent); color: #000; border-color: var(--accent); }
        
        #global-titulo { background: transparent; border: none; font-size: 1.8rem; font-weight: bold; color: var(--accent); width: 100%; padding: 5px; margin: 0; }
        #global-titulo:focus { outline: 1px dashed #555; background: rgba(255,255,255,0.05); }

        .btn-file { background: #444; border: 1px solid #666; color: #fff; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; text-decoration: none; transition: 0.2s; }
        .btn-file:hover { background: #555; border-color: #888; color: #fff; }
        
        .btn-folder { background: var(--success); border-color: var(--success); font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .btn-folder:hover { background: #218838; border-color: #1e7e34; filter: brightness(1.1); }
        .btn-folder.loaded { background: #1e7e34; border-color: #155724; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }

        .chk-label { display: flex; align-items: center; gap: 5px; cursor: pointer; margin: 0; font-size: 0.9rem; }
        .chk-input { width: 18px; height: 18px; cursor: pointer; }

        input[type="color"] { -webkit-appearance: none; border: 1px solid #555; width: 50px; height: 40px; padding: 0; background: none; cursor: pointer; border-radius: 4px; overflow: hidden; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
        
        .fase-wrapper { margin-bottom: 10px; border: 1px solid #444; border-radius: 6px; background: #252526; overflow: hidden; transition: transform 0.2s; }
        .fase-wrapper:hover { border-color: #666; }
        .fase-row { padding: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .audio-panel { background: #151515; padding: 10px; border-top: 1px dashed #444; display: none; }
        .audio-panel.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }
        
        .audio-slot { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 8px; background: #222; padding: 8px; border-radius: 4px; border-left: 3px solid var(--accent); flex-wrap: wrap; transition: opacity 0.3s; }
        .audio-slot .grp { display: flex; flex-direction: column; }
        .audio-slot label { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
        .audio-slot input[type="number"] { width: 50px; padding: 5px; font-size: 0.9rem; background: #333; border: 1px solid #555; }
        
        .file-status { font-size: 0.75rem; margin-top: 4px; display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.3); padding: 3px 6px; border-radius: 3px; border: 1px solid #333; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .status-ok { color: var(--success); border-left: 3px solid var(--success); }
        .status-missing { color: var(--danger); border-left: 3px solid var(--danger); }
        
        .grp.disabled { opacity: 0.3; pointer-events: none; }
        .col-intervalo, .col-estouro, .col-audio { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px; display: flex; gap: 5px; border: 1px dashed #444; }
        .hidden { display: none !important; }

        .btn-x { background: var(--danger); color: white; border: none; width: 25px; height: 25px; border-radius: 50%; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .btn-x:hover { transform: scale(1.1); }
        .btn-add { background: #444; color: white; border: 1px solid #666; padding: 10px 20px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-add:hover { background: #555; }
        .btn-go { background: linear-gradient(135deg, #00d2ff, #0072ff); color: white; border: none; padding: 15px; flex-grow: 1; font-weight: bold; font-size: 1.1rem; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3); transition: transform 0.1s; }
        .btn-go:active { transform: scale(0.98); }

        /* --- APRESENTA√á√ÉO --- */
        #display-screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; background-color: #000; background-size: cover; background-position: center; position: relative; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1; }
        
        #relogio-real { position: absolute; top: 15px; right: 20px; z-index: 20; font-size: 1.5rem; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; border: 1px solid #444; backdrop-filter: blur(4px); }
        #btn-sair { position: absolute; top: 15px; left: 20px; z-index: 20; background: none; border: none; color: #555; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
        #btn-sair:hover { color: #fff; }

        .conteudo-box { z-index: 10; text-align: center; padding: 40px; border-radius: 20px; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px); min-width: 60%; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.6); position: relative; border: 1px solid rgba(255,255,255,0.1); }
        
        #display-global-titulo { font-size: 1.5rem; color: #fff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; opacity: 0.8; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #titulo-fase { font-size: 2.5rem; margin: 0; text-transform: uppercase; color: #fff; letter-spacing: 2px; position: relative; z-index: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        #lbl-fim { position: absolute; top: 0; left: 0; width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; font-size: 8rem; color: var(--danger); font-weight: 900; background: rgba(0,0,0,0.95); z-index: 50; border-radius: 20px 20px 0 0; line-height: 1; text-transform: uppercase; opacity: 0; pointer-events: none; }
        #lbl-fim.ativo { opacity: 1; }

        #timer-principal { font-size: 9rem; margin: 0; font-weight: bold; line-height: 1; font-variant-numeric: tabular-nums; position: relative; z-index: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .timer-waiting { font-size: 4rem !important; color: #777 !important; text-shadow: none !important; }

        #info-horarios { display: flex; justify-content: center; gap: 40px; margin-top: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; font-size: 1.1rem; color: #aaa; }
        #info-horarios span { display: flex; align-items: center; gap: 8px; }

        #rodape-info { margin-top: 15px; font-size: 1.2rem; color: #aaa; padding-top: 10px; display: flex; justify-content: space-between;}

        .controles-play { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-ctrl { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; min-width: 120px; transition: background 0.2s;}
        .btn-ctrl:hover { background: rgba(255,255,255,0.2); }
        .btn-proximo { background: var(--warning); color: #000; font-weight: bold; font-size: 1.5rem; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; margin-top: 20px; box-shadow: 0 0 20px rgba(255, 170, 0, 0.4); }

        /* MODAIS */
        .modal-base { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; max-width: 500px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .modal-opts { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 15px; border: none; background: #333; color: white; text-align: left; cursor: pointer; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .btn-modal:hover { background: #444; padding-left: 20px; }
        .btn-modal b { font-size: 1.1em; }

        .dist-option { border-left: 4px solid var(--accent); }
        .dist-option:hover { background: rgba(0, 210, 255, 0.1); }

        #modal-audio-pause { z-index: 110; }
        .audio-pause-box { background: #222; padding: 25px; border-radius: 10px; border: 1px solid var(--accent); max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,210,255,0.3); }
        .btn-aud-opt { padding: 12px; border: none; color: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; text-align: left; font-size: 1rem; width: 100%; margin-bottom: 10px;}
        
        #reprogram-list { max-height: 200px; overflow-y: auto; text-align: left; margin-bottom: 15px; border: 1px solid #444; padding: 10px; }
        .reprogram-row { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
        .reprogram-row label { font-size: 0.9rem; color: #ccc; }
        .reprogram-row input { width: 60px; padding: 5px; background: #111; border: 1px solid #555; color: white; }

        #custom-tooltip { position: fixed; background: rgba(0, 0, 0, 0.95); border: 1px solid var(--accent); color: #fff; padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; pointer-events: none; z-index: 9999; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.8); max-width: 250px; line-height: 1.4; }

        /* Anima√ß√µes */
        .piscando-cor { animation: pulse-opacity 1s infinite; }
        @keyframes pulse-opacity { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.02); } }
        .piscando-vermelho { color: var(--danger) !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); text-shadow: 0 0 20px red; } }
        .piscando-alerta-maximo { animation: flash-timer-panic 0.5s infinite; }
        @keyframes flash-timer-panic { 0%, 49% { color: var(--danger); transform: scale(1.05); } 50%, 100% { color: var(--txt-color); transform: scale(1); } }
        .bg-panic { animation: bg-flash 1s infinite; }
        @keyframes bg-flash { 0%, 100% { background-color: #300000; } 50% { background-color: #aa0000; } }
        @keyframes flash-strobe { 0%, 15% { opacity: 1; } 16%, 100% { opacity: 0; } }
        .anim-slow { animation: flash-strobe 2.5s infinite; }
        .anim-med { animation: flash-strobe 1.5s infinite; }
        .anim-fast { animation: flash-strobe 0.5s infinite; }
        .anim-panic { animation: flash-strobe-panic 0.4s infinite; }
    </style>
</head>
<body>

    <div id="custom-tooltip"></div>
    <input type="file" id="file-input" style="display: none;" accept=".json" onchange="carregarArquivo(this)">
    <input type="file" id="folder-input" style="display: none;" webkitdirectory directory onchange="processarPastaTrabalho(this)">

    <div id="config-screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px; flex-grow:1; margin-right:20px;">
                <input type="text" id="global-titulo" value="Escola Sabatina Viva" data-tooltip="Clique para editar o t√≠tulo do evento.">
                <input type="color" id="global-cor-titulo" value="#00d2ff" style="width:40px; height:35px; border:none;" data-tooltip="Alterar cor do t√≠tulo.">
                <label class="chk-label"><input type="checkbox" id="chk-exibir-titulo" class="chk-input"> Exibir</label>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-midia" class="btn-file btn-folder" onclick="document.getElementById('folder-input').click()" data-tooltip="PASSO 1: Selecione a pasta onde est√£o seus arquivos de √°udio/imagem.">üìÇ Pasta M√≠dia</button>
                <a href="manual.html" target="_blank" class="btn-file" data-tooltip="Ver Manual de Uso">‚ùì Manual</a>
                <a href="sobre.html" target="_blank" class="btn-file" data-tooltip="Sobre o Sistema">‚ÑπÔ∏è Sobre</a>
                <button class="btn-file" onclick="acaoSalvar()" data-tooltip="Salvar a programa√ß√£o (JSON).">üíæ Salvar</button>
                <button class="btn-file" onclick="acaoAbrir()" data-tooltip="Carregar arquivo JSON.">üìÇ Abrir</button>
            </div>
        </div>
        
        <div class="painel-top">
            <div class="campo" data-tooltip="In√≠cio da programa√ß√£o.">
                <label>In√≠cio Planejado</label>
                <div class="time-group" id="group-inicio">
                    <input type="time" id="hora-inicio">
                    <button class="btn-small" onclick="calcSetInicioAgora()" data-tooltip="Definir para AGORA">‚è±Ô∏è</button>
                    <button class="btn-small" onclick="calcInicioPeloFim()" data-tooltip="Calcular In√≠cio baseado no Fim">‚è™</button>
                </div>
                <label class="chk-label" style="margin-top:5px; font-size:0.8rem; color:#aaa;">
                    <input type="checkbox" id="chk-ignorar-inicio" class="chk-input" onchange="toggleIgnorarInicio()"> Ignorar In√≠cio
                </label>
            </div>
            
            <div class="campo" data-tooltip="Hor√°rio limite.">
                <label>Fim Absoluto</label>
                <div class="time-group" id="group-fim">
                    <input type="time" id="hora-fim">
                    <button class="btn-small" onclick="calcFimPeloInicio()" data-tooltip="Calcular Fim baseado no In√≠cio">‚è©</button>
                </div>
                <label class="chk-label" style="margin-top:5px; font-size:0.8rem; color:#aaa;">
                    <input type="checkbox" id="chk-ignorar-fim" class="chk-input" onchange="toggleIgnorarFim()"> Ignorar Fim (Livre)
                </label>
            </div>
            
            <div class="campo" style="flex-direction: row; align-items: center; gap: 20px; padding-bottom: 5px;">
                <label class="chk-label"><input type="checkbox" id="chk-intervalos" onchange="toggleIntervalosGlobais()" class="chk-input"> Intervalos</label>
                <label class="chk-label"><input type="checkbox" id="chk-estouro-global" onchange="toggleEstouroGlobal()" class="chk-input"> Permitir Estouro</label>
                <label class="chk-label"><input type="checkbox" id="chk-audio-global" onchange="toggleAudioGlobal()" class="chk-input"> Permitir √Åudio</label>
            </div>
        </div>

        <div id="lista-fases"></div>

        <div style="display:flex; gap:15px; margin-top:20px; padding-bottom:50px;">
            <button class="btn-add" onclick="adicionarFase()" data-tooltip="Adiciona nova linha.">+ Nova Etapa</button>
            <button class="btn-go" onclick="iniciarApresentacao()" data-tooltip="Inicia o cron√¥metro e bloqueia a tela.">INICIAR APRESENTA√á√ÉO ‚ñ∑</button>
        </div>
    </div>

    <div id="display-screen">
        <button id="btn-sair" onclick="encerrar()" title="Sair" data-tooltip="Sair e voltar √† configura√ß√£o">‚úï</button>
        <div class="overlay"></div>
        <div id="relogio-real" data-tooltip="Hora Atual">--:--</div>

        <div class="conteudo-box" id="box-principal">
            <h1 id="display-global-titulo" class="hidden"></h1>
            <h2 id="titulo-fase">...</h2>
            <div id="lbl-fim">FIM</div>
            <div id="area-timer" data-tooltip="Tempo restante"><div id="timer-principal">00:00</div></div>
            <button id="btn-intervalo-manual" class="btn-proximo hidden" onclick="sairIntervaloManual()" data-tooltip="Iniciar pr√≥xima parte">INICIAR PR√ìXIMA PARTE ‚ñ∂</button>
            
            <div id="info-horarios">
                <span data-tooltip="Hor√°rio limite configurado (Fim Absoluto)">üèÅ Limite: <strong id="lbl-fim-absoluto" style="color:#e0e0e0">--:--</strong></span>
                <span data-tooltip="Previs√£o de t√©rmino baseada no tempo restante">üîÆ Previs√£o: <strong id="lbl-fim-previsto" style="color:#28a745">--:--</strong></span>
            </div>

            <div id="rodape-info"><span id="txt-status" style="color:#00d2ff;">Tempo Normal</span><span id="txt-proximo">Pr√≥ximo: ...</span></div>
            <div class="controles-play">
                <button id="btn-pausar" class="btn-ctrl" onclick="acaoPausar()" data-tooltip="Pausar ou Parar o tempo">‚è∏ PAUSAR</button>
                <button id="btn-continuar" class="btn-ctrl hidden" onclick="acaoContinuar()" data-tooltip="Continuar contagem">‚ñ∂ Continuar</button>
                <button class="btn-ctrl" onclick="acaoAdicionarTempo()" style="border-color:#00d2ff; color:#00d2ff;" data-tooltip="Adiciona 1 minuto extra.">+1 Min</button>
                <button class="btn-ctrl" onclick="acaoReiniciarFase()" style="border-color:#ffaa00; color:#ffaa00;" data-tooltip="Reiniciar etapa atual">‚Ü∫ Reiniciar</button>
                <button id="btn-avancar" class="btn-ctrl" onclick="acaoAvan√ßar()" style="border-color:#00d2ff; color:#00d2ff;" data-tooltip="Pular etapa.">‚è≠ Avan√ßar</button>
                <button class="btn-ctrl" onclick="encerrar()" style="border-color:#ff4444; color:#ff4444;" data-tooltip="Sair.">‚èπ Encerrar</button>
            </div>
        </div>
    </div>

    <div id="modal-severe-delay" class="modal-base">
        <div class="modal-box" style="border-color:#ff4444;">
            <h2 style="color:#ff4444; margin-top:0;">üõë Atraso Cr√≠tico</h2>
            <p>O atraso √© maior que a 1¬™ fase inteira ou 25% do total.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:var(--warning); color:black;" onclick="handleSevereAction('ignore')"><b>üîì Ignorar Tempo Final</b> <span>(Prosseguir)</span></button>
                <button class="btn-modal" style="background:#444;" onclick="handleSevereAction('cancel')"><b>‚úèÔ∏è AJUSTAR</b> <span>(Voltar)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-moderate-delay" class="modal-base">
        <div class="modal-box" style="border-color:var(--warning);">
            <h2 style="color:var(--warning); margin-top:0;">‚ö†Ô∏è Atraso Consider√°vel</h2>
            <p>O tempo √© insuficiente. Escolha uma solu√ß√£o:</p>
            <div class="modal-opts" style="max-height:400px; overflow-y:auto;">
                <button class="btn-modal" onclick="handleModerateAction(1)"><b>1. Descontar da 1¬™ Fase</b> <span id="lbl-mod-1"></span></button>
                <button class="btn-modal" onclick="handleModerateAction(2)"><b>2. Eliminar 1¬™ Fase e Distribuir</b> <span>(Para todas)</span></button>
                <button class="btn-modal" onclick="handleModerateAction(3)"><b>3. Eliminar 1¬™ Fase e Flexibilizar</b> <span>(S√≥ Flex)</span></button>
                <button class="btn-modal" onclick="handleModerateAction(4)"><b>4. Descontar da √öltima Fase</b> <span id="lbl-mod-4"></span></button>
                <button class="btn-modal" style="background:#444;" onclick="handleModerateAction(5)"><b>5. Reajustar Manualmente</b> <span>(Voltar)</span></button>
                <button class="btn-modal" style="background:var(--accent); color:black;" onclick="handleModerateAction(6)"><b>6. Ajustar Limite</b> <span>(Empurrar Fim)</span></button>
                <button class="btn-modal" style="background:var(--danger);" onclick="handleModerateAction(7)"><b>7. Ignorar Limites</b> <span>(Modo Livre)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-runtime-adjust" class="modal-base">
        <div class="modal-box" style="border-color:#ff4444;">
            <h2 style="color:#ff4444; margin-top:0;">‚ö†Ô∏è Tempo Esgotado</h2>
            <p>O tempo limite foi atingido.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:#007bff;" onclick="handleRuntimeAction('auto')"><b>üìâ Ajustar Tempo</b> <span>(Comprimir Flex√≠veis)</span></button>
                <button class="btn-modal" style="background:var(--warning); color:black;" onclick="handleRuntimeAction('ignore')"><b>üîì Ignorar Limites</b> <span>(Prosseguir)</span></button>
                <button class="btn-modal" style="background:#444;" onclick="handleRuntimeAction('reprogram')"><b>üìù Reprogramar</b> <span>(Manual)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-reprogram-manual" class="modal-base" style="z-index: 120;">
        <div class="modal-box" style="border-color:var(--accent);">
            <h2 style="color:var(--accent); margin-top:0;">üìù Reprograma√ß√£o Manual</h2>
            <div id="reprogram-list"></div>
            <div class="reprogram-row" style="border-top:1px solid #555; padding-top:10px; margin-top:10px;">
                <label>Novo Hor√°rio Limite:</label>
                <input type="time" id="new-end-time-input">
            </div>
            <div class="modal-opts" style="flex-direction:row;">
                <button class="btn-modal" style="flex:1; background:var(--success);" onclick="applyReprogramming()"><b>Salvar</b></button>
                <button class="btn-modal" style="flex:1; background:#444; justify-content:center;" onclick="document.getElementById('modal-reprogram-manual').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-already-finished" class="modal-base">
        <div class="modal-box" style="border-color: #ff4444;">
            <h2 style="color: #ff4444; margin-top:0;">üö´ Hor√°rios Incompat√≠veis</h2>
            <p>O hor√°rio de t√©rmino programado j√° passou.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:var(--warning); color:black;" onclick="handleFinishedEvent('ignore')"><b>üîì IGNORAR HOR√ÅRIOS</b> <span>(Modo Livre)</span></button>
                <button class="btn-modal" style="background:#444;" onclick="handleFinishedEvent('cancel')"><b>‚úèÔ∏è AJUSTAR</b> <span>(Voltar)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-conflito-calc" class="modal-base">
        <div class="modal-box" style="border-color:#ffaa00;">
            <h2 style="color:#ffaa00; margin-top:0;">‚ö†Ô∏è Tempo Insuficiente</h2>
            <p>Para terminar no hor√°rio estipulado, o evento deveria ter come√ßado no passado (<span id="span-hora-calc"></span>).</p>
            <div class="modal-opts">
                <button id="btn-distribuir-calc" class="btn-modal" style="background:#007bff; font-weight:bold;" onclick="resolverConflitoCalc(1)"><b>üìâ DISTRIBUIR</b> (Comprimir Flex√≠veis)</button>
                <button class="btn-modal" style="background:#28a745; color:white;" onclick="resolverConflitoCalc(2)"><b>üïì AJUSTAR FIM</b> (Mover Fim para Frente)</button>
                <button class="btn-modal" style="background:#444;" onclick="resolverConflitoCalc(0)">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-late-start" class="modal-base">
        <div class="modal-box" style="border-color:#ff4444;">
            <h2 style="color:#ff4444; margin-top:0;">‚ö†Ô∏è Tempo Insuficiente</h2>
            <p>N√£o h√° tempo suficiente at√© o hor√°rio final.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:var(--danger); color:white;" onclick="handleLateStart('first')"><b>üî™ Sacrificar 1¬™ Etapa</b> <span>(Reduzir In√≠cio)</span></button>
                <button class="btn-modal" style="background:#007bff; color:white;" onclick="handleLateStart('flex')"><b>üìâ Comprimir Flex√≠veis</b> <span>(Distribuir)</span></button>
                <button class="btn-modal" style="background:var(--success); color:white;" onclick="handleLateStart('push')"><b>‚è© Mover Fim</b> <span>(Aceitar Atraso)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-surplus-check" class="modal-base">
        <div class="modal-box" style="border-color:#00d2ff;">
            <h2 style="color:#00d2ff; margin-top:0;">‚è≥ Tempo de Sobra Detectado</h2>
            <p>H√° uma folga de <b><span id="surplus-display-val"></span> minutos</b> at√© o limite final.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:#444;" onclick="handleSurplusDecision('wait')"><b>‚è≥ INSERIR AGUARDE</b> (Queimar Tempo)</button>
                <button class="btn-modal" style="background:#28a745; color:white;" onclick="handleSurplusDecision('distribute')"><b>üéÅ DISTRIBUIR NAS FASES</b></button>
                <button class="btn-modal" style="background:#007bff; color:white;" onclick="handleSurplusDecision('start')"><b>‚ñ∂ INICIAR DIRETO</b> (Terminar Cedo)</button>
            </div>
        </div>
    </div>

    <div id="modal-surplus-dist" class="modal-base">
        <div class="modal-box" style="border-color:#28a745;">
            <h2 style="color:#28a745; margin-top:0;">üéÅ Distribuir Tempo Extra</h2>
            <div class="modal-opts">
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('all')"><b>1. Distribuir Geral</b> <span>(Todas Prop.)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('first')"><b>2. + 1¬™ Fase</b> <span id="lbl-first-phase" style="font-size:0.8em; color:#aaa;">(...)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('last')"><b>3. + √öltima Fase</b> <span>(Fim)</span></button>
                <button class="btn-modal dist-option" onclick="handleSurplusDistribution('flex')"><b>4. + Flex√≠veis</b> <span>(Apenas Flex√≠veis)</span></button>
            </div>
        </div>
    </div>

    <div id="modal-early-start" class="modal-base">
        <div class="modal-box" style="border-color:#00d2ff;">
            <h2 style="color:#00d2ff; margin-top:0;">‚è≥ In√≠cio Antecipado</h2>
            <p>Voc√™ est√° adiantado em rela√ß√£o ao hor√°rio de in√≠cio!</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background:#444;" onclick="handleEarlyStart('wait')"><b>‚úã AGUARDAR</b> (Modo Espera)</button>
                <button class="btn-modal" style="background:#28a745; color:white;" onclick="handleEarlyStart('start')"><b>‚ñ∂ INICIAR</b></button>
            </div>
        </div>
    </div>

    <div id="modal-audio-pause" class="modal-base" style="z-index: 110;">
        <div class="audio-pause-box">
            <h2 style="color:#00d2ff; margin-top:0;">üéµ √Åudio em Execu√ß√£o</h2>
            <p>O tempo parou, mas h√° um √°udio tocando. O que fazer?</p>
            <div class="audio-pause-opts">
                <button class="btn-aud-opt" style="background:#28a745;" onclick="resolverAudioPause('continue')">üîä PROSSEGUIR √ÅUDIO (Deixar tocando)</button>
                <button class="btn-aud-opt" style="background:#ffaa00; color:#000;" onclick="resolverAudioPause('pause')">‚è∏Ô∏è PAUSAR √ÅUDIO (Retoma ao voltar)</button>
                <button class="btn-aud-opt" style="background:#007bff;" onclick="resolverAudioPause('restart')">‚èÆÔ∏è REINICIAR √ÅUDIO (Do come√ßo)</button>
                <button class="btn-aud-opt" style="background:#ff4444;" onclick="resolverAudioPause('stop')">‚èπÔ∏è PARAR √ÅUDIO (Encerrar)</button>
            </div>
        </div>
    </div>

    <div id="modal-missing-media" class="modal-base">
        <div class="modal-box" style="border-color: var(--warning);">
            <h2 style="color: var(--warning); margin-top:0;">üìÇ Pasta de M√≠dia Necess√°ria</h2>
            <p>Este arquivo cont√©m refer√™ncias a imagens ou √°udios.</p>
            <div class="modal-opts">
                <button class="btn-modal" style="background: var(--success); color:white;" onclick="resolveMissingMedia()"><b>üìÅ Selecionar Pasta</b></button>
                <button class="btn-modal" style="background: #444;" onclick="document.getElementById('modal-missing-media').style.display='none'">Ignorar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. VARI√ÅVEIS GLOBAIS ---
        let mediaCache = {}; 
        let cronograma = []; 
        let indexAtual = 0; 
        let tempoRestante = 0; 
        let estado = "PARADO"; 
        let intervaloTimer = null; 
        let dataFimGlobal = null; 
        let emIntervalo = false;
        let activeAudio = null; 
        let audioResumeAction = null;
        let surplusMinutes = 0;
        let deficitSeconds = 0; 
        let pendingDataInicio = null;
        let wakeLock = null; 
        let audioCtxGlobal = null; 

        // --- 2. FUN√á√ïES AUXILIARES ---
        function montarData(s, ref) {
            const [h, m] = s.split(':');
            const d = new Date(ref);
            d.setHours(parseInt(h), parseInt(m), 0, 0);
            return d;
        }

        function formatTime(date) {
            return String(date.getHours()).padStart(2,'0') + ":" + String(date.getMinutes()).padStart(2,'0');
        }

        function getAudioContext() {
            if (!audioCtxGlobal) {
                audioCtxGlobal = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtxGlobal.state === 'suspended') {
                audioCtxGlobal.resume();
            }
            return audioCtxGlobal;
        }

        async function ativarWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.warn(`${err.name}, ${err.message}`); }
            }
        }

        function liberarWakeLock() {
            if (wakeLock !== null) { wakeLock.release().then(() => { wakeLock = null; }); }
        }

        function obterDuracaoTotalMinutos() {
            let totalMin = 0;
            const rows = document.querySelectorAll('.fase-row');
            const globalInt = document.getElementById('chk-intervalos').checked;
            rows.forEach((r, idx) => {
                const m = parseFloat(r.querySelector('.inp-tempo').value) || 0;
                totalMin += m;
                if (globalInt && idx < rows.length - 1) {
                    const intS = parseInt(r.querySelector('.inp-int-tempo').value) || 0;
                    totalMin += (intS / 60);
                }
            });
            return totalMin;
        }

        // --- 3. L√ìGICA DE √ÅUDIO E CORE DO SISTEMA ---
        
        function tocarBip(freq = 440, dur = 0.1, type = 'sine') {
            try {
                const ctx = getAudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + dur);
                osc.stop(ctx.currentTime + dur);
            } catch(e) { console.log("Erro de √Åudio"); }
        }

        function playSmartAudio(audObj) {
            if (!mediaCache[audObj.fileName]) return;
            // Interrompe anterior se houver
            if (activeAudio) { activeAudio.audio.pause(); activeAudio = null; }
            
            const file = mediaCache[audObj.fileName];
            const url = URL.createObjectURL(file);
            const audio = new Audio(url);
            
            audio.loop = audObj.loop;
            audio.play().catch(e => console.log("Erro play audio", e));
            
            activeAudio = {
                audio: audio,
                el: { customFlags: audObj } // Compatibility wrapper for tick logic
            };
        }

        function fadeAndStop(audRef, duration) {
            if(!audRef || !audRef.audio) return;
            const audio = audRef.audio;
            // Simple fade out via interval
            let vol = 1;
            const step = 0.05;
            const interval = 200; // ms
            const fade = setInterval(() => {
                if (vol > 0) {
                    vol -= step;
                    audio.volume = Math.max(0, vol);
                } else {
                    clearInterval(fade);
                    audio.pause();
                    if(activeAudio === audRef) activeAudio = null;
                }
            }, interval);
        }

        function construirCronograma() {
            cronograma = [];
            const wrappers = document.querySelectorAll('.fase-wrapper');
            if (wrappers.length === 0) return;

            wrappers.forEach((wrapper, idx) => {
                const row = wrapper.querySelector('.fase-row');
                const min = parseFloat(row.querySelector('.inp-tempo').value) || 0;
                const seg = Math.floor(min * 60);
                
                // Mapeia √°udios
                const customAudios = [];
                wrapper.querySelectorAll('.audio-slot').forEach(slot => {
                    const m = parseInt(slot.querySelector('.aud-min').value) || 0;
                    const s = parseInt(slot.querySelector('.aud-sec').value) || 0;
                    // Trigger: dispara quando faltar X segundos (contagem regressiva)
                    const triggerTime = (m * 60) + s; 
                    
                    const fName = slot.dataset.filename || (slot.querySelector('.aud-file').files[0] ? slot.querySelector('.aud-file').files[0].name : "");

                    if (fName) {
                        customAudios.push({
                            trigger: triggerTime, // O tick compara tempoRestante === trigger
                            fileName: fName,
                            loop: slot.querySelector('.aud-loop').checked,
                            stopAtZero: slot.querySelector('.aud-stopzero').checked
                        });
                    }
                });

                cronograma.push({
                    titulo: row.querySelector('.inp-titulo').value,
                    segundosFinais: seg,
                    minutosOrig: min,
                    flexivel: row.querySelector('.inp-flexivel').checked,
                    bg: row.querySelector('.inp-bg').value,
                    txt: row.querySelector('.inp-txt').value,
                    aviso: parseInt(row.querySelector('.inp-aviso').value) || 30,
                    permitirEstouro: row.querySelector('.inp-estouro-fase').checked,
                    imgName: row.dataset.imgname || null,
                    customAudios: customAudios,
                    temIntervalo: document.getElementById('chk-intervalos').checked,
                    intTempo: parseFloat(row.querySelector('.inp-int-tempo').value) * 60 || 0,
                    intManual: row.querySelector('.inp-int-manual').checked
                });
            });
        }

        function rodarFase(idx) {
            if (intervaloTimer) clearInterval(intervaloTimer);
            
            if (idx >= cronograma.length) {
                document.getElementById('lbl-fim').classList.add('ativo');
                document.getElementById('timer-principal').innerHTML = "FIM";
                document.getElementById('box-principal').style.backgroundColor = "#000";
                document.getElementById('titulo-fase').innerText = "Encerrado";
                tocarBip(880, 0.5, 'triangle'); 
                return;
            }

            indexAtual = idx;
            const fase = cronograma[idx];
            tempoRestante = fase.segundosFinais;
            estado = "RODANDO";
            emIntervalo = false;

            document.getElementById('titulo-fase').innerText = fase.titulo;
            document.getElementById('titulo-fase').style.color = fase.txt;
            
            const display = document.getElementById('display-screen');
            if (fase.imgName && mediaCache[fase.imgName]) {
                const url = URL.createObjectURL(mediaCache[fase.imgName]);
                display.style.backgroundImage = `url('${url}')`;
            } else {
                display.style.backgroundImage = 'none';
                display.style.backgroundColor = fase.bg;
            }

            document.getElementById('box-principal').style.color = fase.txt;
            
            tick(); 
            intervaloTimer = setInterval(tick, 1000);
            atualizarBotoes(true);
        }

        function gerenciarIntervalo() {
            const faseAnterior = cronograma[indexAtual];
            if (!faseAnterior.temIntervalo || indexAtual >= cronograma.length - 1) {
                rodarFase(indexAtual + 1);
                return;
            }

            emIntervalo = true;
            estado = "INTERVALO";
            
            document.getElementById('titulo-fase').innerText = "INTERVALO";
            document.getElementById('box-principal').style.backgroundColor = "#222";
            document.getElementById('display-screen').style.backgroundImage = "none";
            document.getElementById('display-screen').style.backgroundColor = "#000";

            if (faseAnterior.intManual) {
                document.getElementById('timer-principal').innerText = "PAUSA";
                document.getElementById('btn-intervalo-manual').classList.remove('hidden');
                clearInterval(intervaloTimer);
            } else {
                tempoRestante = faseAnterior.intTempo;
                intervaloTimer = setInterval(tick, 1000);
            }
        }

        function sairIntervaloManual() {
            document.getElementById('btn-intervalo-manual').classList.add('hidden');
            rodarFase(indexAtual + 1);
        }

        function atualizarBotoes(rodando) {
            if(rodando) {
                document.getElementById('btn-pausar').classList.remove('hidden');
                document.getElementById('btn-continuar').classList.add('hidden');
            } else {
                document.getElementById('btn-pausar').classList.add('hidden');
                document.getElementById('btn-continuar').classList.remove('hidden');
            }
        }

        function acaoPausar() {
            if (intervaloTimer) clearInterval(intervaloTimer);
            estado = "PAUSADO";
            atualizarBotoes(false);
            if (activeAudio) {
                 document.getElementById('modal-audio-pause').style.display = 'flex';
            }
        }

        function acaoContinuar() {
            if (estado === "PAUSADO") {
                estado = emIntervalo ? "INTERVALO" : "RODANDO";
                intervaloTimer = setInterval(tick, 1000);
                atualizarBotoes(true);
                if (audioResumeAction === 'pause' && activeAudio) activeAudio.audio.play();
                document.getElementById('modal-audio-pause').style.display = 'none';
            }
        }

        function acaoAvan√ßar() { rodarFase(indexAtual + 1); }
        function acaoAdicionarTempo() { tempoRestante += 60; tick(); }
        function acaoReiniciarFase() { rodarFase(indexAtual); }
        function encerrar() {
            if (intervaloTimer) clearInterval(intervaloTimer);
            liberarWakeLock();
            if (activeAudio) { activeAudio.audio.pause(); activeAudio = null; }
            document.getElementById('display-screen').style.display = 'none';
            document.getElementById('config-screen').style.display = 'block';
            if (document.exitFullscreen) document.exitFullscreen();
        }

        function resolverAudioPause(action) {
            audioResumeAction = action;
            if (action === 'stop' && activeAudio) { activeAudio.audio.pause(); activeAudio = null; }
            if (action === 'restart' && activeAudio) { activeAudio.audio.currentTime = 0; activeAudio.audio.play(); }
            if (action === 'pause' && activeAudio) { activeAudio.audio.pause(); }
            document.getElementById('modal-audio-pause').style.display = 'none';
        }

        function atualizarPrevisaoEntrega() {
            let segundosFuturos = (tempoRestante > 0 ? tempoRestante : 0);
            for(let i = indexAtual + 1; i < cronograma.length; i++) {
                segundosFuturos += cronograma[i].segundosFinais;
                if(cronograma[i].temIntervalo && !cronograma[i].intManual) {
                     segundosFuturos += cronograma[i].intTempo;
                }
            }
            const now = new Date();
            const prev = new Date(now.getTime() + (segundosFuturos * 1000));
            
            const elPrev = document.getElementById('lbl-fim-previsto');
            elPrev.innerText = formatTime(prev);

            if (dataFimGlobal && prev > dataFimGlobal) elPrev.style.color = "#ff4444";
            else elPrev.style.color = "#28a745";
            
            const elProx = document.getElementById('txt-proximo');
            if (indexAtual + 1 < cronograma.length) elProx.innerText = "Pr√≥ximo: " + cronograma[indexAtual + 1].titulo;
            else elProx.innerText = "Pr√≥ximo: Fim";
        }

        // --- 4. FUN√á√ïES DOM (UI Builders) ---
        function recalcularOpcoesAudio(wrapper) {
            if (!wrapper) return;
            const slots = Array.from(wrapper.querySelectorAll('.audio-slot'));
            if (slots.length === 0) return;
            let minTime = Infinity; 
            let lastSlot = null; 
            
            slots.forEach(slot => {
                const m = parseInt(slot.querySelector('.aud-min').value) || 0;
                const s = parseInt(slot.querySelector('.aud-sec').value) || 0;
                const totalSec = (m * 60) + s;
                if (totalSec < minTime) { minTime = totalSec; lastSlot = slot; }
            });
            slots.forEach(slot => {
                const grpPlay = slot.querySelector('.grp-playthrough');
                const chkPlay = slot.querySelector('.aud-playthrough');
                const grpCont = slot.querySelector('.grp-continue');
                const chkCont = slot.querySelector('.aud-continue');
                const grpStop = slot.querySelector('.grp-stopzero');
                const chkStop = slot.querySelector('.aud-stopzero');
                if (slot === lastSlot) {
                    chkPlay.disabled = false; grpPlay.classList.remove('disabled');
                    chkCont.disabled = false; grpCont.classList.remove('disabled');
                    const m = parseInt(slot.querySelector('.aud-min').value) || 0;
                    const s = parseInt(slot.querySelector('.aud-sec').value) || 0;
                    if (m === 0 && s === 0) { chkStop.checked = false; chkStop.disabled = true; grpStop.classList.add('disabled'); }
                    else { chkStop.disabled = false; grpStop.classList.remove('disabled'); }
                } else {
                    chkPlay.checked = false; chkPlay.disabled = true; grpPlay.classList.add('disabled');
                    chkCont.checked = false; chkCont.disabled = true; grpCont.classList.add('disabled');
                    chkStop.checked = false; chkStop.disabled = true; grpStop.classList.add('disabled');
                }
            });
        }

        function ensureExclusive(checkbox) {
            if (!checkbox.checked) return;
            const slot = checkbox.closest('.audio-slot');
            const chkPlay = slot.querySelector('.aud-playthrough');
            const chkStop = slot.querySelector('.aud-stopzero');
            const chkCont = slot.querySelector('.aud-continue');
            if (checkbox === chkPlay) { chkStop.checked = false; chkCont.checked = false; }
            if (checkbox === chkStop) { chkPlay.checked = false; chkCont.checked = false; }
            if (checkbox === chkCont) { chkPlay.checked = false; chkStop.checked = false; }
        }

        function uiAtualizarFase(row) {
            const chkEstouro = row.querySelector('.inp-estouro-fase');
            const colIntervalo = row.querySelector('.col-intervalo');
            const chkManual = row.querySelector('.inp-int-manual');
            const boxTempoInt = row.querySelector('.inp-int-tempo').parentElement;
            const globalIntervalos = document.getElementById('chk-intervalos').checked;
            if (chkEstouro.checked) colIntervalo.classList.add('hidden');
            else { 
                if (globalIntervalos) colIntervalo.classList.remove('hidden'); 
                else colIntervalo.classList.add('hidden'); 
            }
            if (chkManual.checked) boxTempoInt.classList.add('hidden'); 
            else boxTempoInt.classList.remove('hidden');
        }

        function verificarStatusMidia(slot) {
            const isImageSlot = slot.classList.contains('fase-row');
            const label = slot.querySelector('.file-status');
            const fname = isImageSlot ? slot.dataset.imgname : slot.dataset.filename;
            if (label) label.remove();
            if (!fname) return;
            let statusHtml = '';
            if (mediaCache[fname]) statusHtml = `<span class="file-status status-ok">‚úÖ ${fname}</span>`;
            else statusHtml = `<span class="file-status status-missing">‚ùå ${fname}</span>`;
            if (isImageSlot) {
                const imgInput = slot.querySelector('.inp-img');
                if (imgInput) imgInput.insertAdjacentHTML('afterend', statusHtml);
            } else {
                const fileInput = slot.querySelector('.aud-file');
                if (fileInput) fileInput.insertAdjacentHTML('afterend', statusHtml);
            }
        }

        function resolveMissingMedia() {
            document.getElementById('modal-missing-media').style.display = 'none';
            document.getElementById('folder-input').click();
        }

        function processarPastaTrabalho(input) {
            let count = 0;
            if (input.files) {
                for (let file of input.files) { mediaCache[file.name] = file; count++; }
            }
            if(count > 0) {
                document.getElementById('btn-midia').innerText = `üìÇ Pasta M√≠dia (${count} arq)`;
                document.getElementById('btn-midia').classList.add('loaded');
                alert(`${count} arquivos mapeados!`);
            }
            document.querySelectorAll('.audio-slot').forEach(slot => verificarStatusMidia(slot));
            document.querySelectorAll('.fase-row').forEach(row => verificarStatusMidia(row));
        }

        function adicionarSlotAudio(panel, min=0, sec=0, dur=0, loop=false, fin=5, fout=5, fname="", playThrough=false, stopZero=false, continueNext=false) {
            let list = panel;
            if (!panel.classList.contains('audio-list')) {
                list = panel.querySelector('.audio-list');
                if (!list) list = panel;
            }
            const div = document.createElement('div');
            div.className = 'audio-slot';
            if (fname) div.dataset.filename = fname;
            div.innerHTML = `
                <div class="grp"><label>Disparo</label><div><input type="number" class="aud-min" value="${min}" placeholder="Min" oninput="recalcularOpcoesAudio(this.closest('.fase-wrapper'))">:<input type="number" class="aud-sec" value="${sec}" placeholder="Seg" oninput="recalcularOpcoesAudio(this.closest('.fase-wrapper'))"></div></div>
                <div class="grp"><label>Arquivo</label><input type="file" class="aud-file" accept="audio/*" onchange="this.closest('.audio-slot').dataset.filename = this.files[0].name; verificarStatusMidia(this.closest('.audio-slot'))"></div>
                <div class="grp"><label>Dura√ß√£o(s)</label><input type="number" class="aud-dur" value="${dur}" placeholder="0=Tudo"></div>
                <div class="grp"><label>Loop</label><input type="checkbox" class="aud-loop" ${loop?'checked':''} style="width:20px;height:20px;"></div>
                <div class="grp"><label>Fade In/Out</label><div><input type="number" class="aud-fin" value="${fin}" style="width:30px">/<input type="number" class="aud-fout" value="${fout}" style="width:30px"></div></div>
                <div class="grp grp-playthrough"><label data-tooltip="Tocar at√© o fim (entra no estouro)">At√© Fim?</label><input type="checkbox" class="aud-playthrough" ${playThrough?'checked':''} style="width:20px;height:20px;" onchange="ensureExclusive(this)"></div>
                <div class="grp grp-stopzero"><label data-tooltip="Cortar em 00:00">Parar 0s?</label><input type="checkbox" class="aud-stopzero" ${stopZero?'checked':''} style="width:20px;height:20px;" onchange="ensureExclusive(this)"></div>
                <div class="grp grp-continue"><label data-tooltip="Continuar na pr√≥xima fase (fundo)">Cont. Pr√≥x?</label><input type="checkbox" class="aud-continue" ${continueNext?'checked':''} style="width:20px;height:20px;" onchange="ensureExclusive(this)"></div>
                <button class="btn-x" style="width:20px; height:20px;" onclick="let w=this.closest('.fase-wrapper'); this.parentElement.remove(); recalcularOpcoesAudio(w);">X</button>
            `;
            list.appendChild(div);
            verificarStatusMidia(div);
            if (div.closest('.fase-wrapper')) recalcularOpcoesAudio(div.closest('.fase-wrapper'));
        }

        function adicionarFase(tit="", min=10, flex=true, bg="#000000", txt="#ffffff", imgName="") {
            const c = document.getElementById('lista-fases');
            const hideInt = document.getElementById('chk-intervalos').checked ? '' : 'hidden';
            const hideEst = document.getElementById('chk-estouro-global').checked ? '' : 'hidden';
            const hideAud = document.getElementById('chk-audio-global').checked ? '' : 'hidden';
            const wrapper = document.createElement('div');
            wrapper.className = 'fase-wrapper';
            const div = document.createElement('div');
            div.className = 'fase-row';
            if(imgName) div.dataset.imgname = imgName;

            div.innerHTML = `
                <button class="btn-x" onclick="this.closest('.fase-wrapper').remove()">X</button>
                <div class="campo" style="flex:2; min-width:150px;"><label>T√≠tulo</label><input type="text" class="inp-titulo" value="${tit}"></div>
                <div class="campo" style="width:70px;"><label>Min</label><input type="number" class="inp-tempo" value="${min}" min="1"></div>
                <div class="campo" style="align-items:center;"><label>Flex?</label><input type="checkbox" class="inp-flexivel" ${flex?'checked':''} style="width:20px; height:20px;"></div>
                <div class="col-estouro ${hideEst}"><div class="campo" style="align-items:center;"><label>Estouro?</label><input type="checkbox" class="inp-estouro-fase" style="width:20px; height:20px;" onchange="uiAtualizarFase(this.closest('.fase-row'))"></div></div>
                <div class="col-audio ${hideAud}"><div class="campo" style="align-items:center;"><label>Beep?</label><input type="checkbox" class="inp-beep-fase" checked style="width:20px; height:20px;"></div></div>
                <div class="col-intervalo ${hideInt}"><div class="campo" style="width:60px;"><label>Pausa</label><input type="number" class="inp-int-tempo" value="30"></div><div class="campo" style="align-items:center;"><label>Clique?</label><input type="checkbox" class="inp-int-manual" style="width:20px; height:20px;" onchange="uiAtualizarFase(this.closest('.fase-row'))"></div></div>
                <div class="campo" style="width:60px;"><label>Aviso</label><input type="number" class="inp-aviso" value="30"></div>
                <div class="campo" data-tooltip="Cor Fundo"><label>Bg</label><input type="color" class="inp-bg" value="${bg}"></div>
                <div class="campo" data-tooltip="Cor Texto"><label>Txt</label><input type="color" class="inp-txt" value="${txt}"></div>
                <div class="campo" style="flex:1;"><label>Img</label><input type="file" class="inp-img" accept="image/*" onchange="this.closest('.fase-row').dataset.imgname = this.files[0].name; verificarStatusMidia(this.closest('.fase-row'))"></div>
                <button class="btn-icon btn-show-audio ${hideAud}" onclick="this.closest('.fase-wrapper').querySelector('.audio-panel').classList.toggle('open')">üéµ</button>
            `;
            const audioPanel = document.createElement('div');
            audioPanel.className = 'audio-panel';
            audioPanel.innerHTML = `<div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">Configura√ß√£o de √Åudio Avan√ßada</div><div class="audio-list"></div><button class="btn-add" style="padding:5px 10px; font-size:0.8rem;" onclick="adicionarSlotAudio(this.parentElement)">+ Novo √Åudio</button>`;
            wrapper.appendChild(div); wrapper.appendChild(audioPanel); c.appendChild(wrapper); uiAtualizarFase(div);
            
            verificarStatusMidia(div);
            return wrapper;
        }

        // --- 5. CONTROLES UI E OP√á√ïES ---
        function toggleIgnorarInicio() {
            const chk = document.getElementById('chk-ignorar-inicio');
            document.getElementById('hora-inicio').disabled = chk.checked;
            document.querySelectorAll('#group-inicio button').forEach(b => b.disabled = chk.checked);
        }
        function toggleIgnorarFim() {
            const chk = document.getElementById('chk-ignorar-fim');
            document.getElementById('hora-fim').disabled = chk.checked;
            document.querySelectorAll('#group-fim button').forEach(b => b.disabled = chk.checked);
        }
        function toggleIntervalosGlobais(){ const c = document.getElementById('chk-intervalos').checked; document.querySelectorAll('.fase-row').forEach(row => uiAtualizarFase(row)); }
        function toggleEstouroGlobal(){ const c = document.getElementById('chk-estouro-global').checked; document.querySelectorAll('.col-estouro').forEach(e => c ? e.classList.remove('hidden') : e.classList.add('hidden')); }
        function toggleAudioGlobal(){
            const c = document.getElementById('chk-audio-global').checked;
            document.querySelectorAll('.col-audio').forEach(e => c ? e.classList.remove('hidden') : e.classList.add('hidden'));
            document.querySelectorAll('.btn-show-audio').forEach(btn => c ? btn.classList.remove('hidden') : btn.classList.add('hidden'));
        }
        function calcSetInicioAgora() { document.getElementById('hora-inicio').value = formatTime(new Date()); }
        function calcFimPeloInicio() {
            const hI = document.getElementById('hora-inicio').value;
            if(!hI) return alert("Defina o in√≠cio primeiro.");
            const dur = obterDuracaoTotalMinutos();
            const d = montarData(hI, new Date());
            d.setMinutes(d.getMinutes() + Math.ceil(dur));
            document.getElementById('hora-fim').value = formatTime(d);
        }
        function calcInicioPeloFim() {
            const hF = document.getElementById('hora-fim').value;
            if(!hF) return alert("Defina o fim primeiro.");
            const dur = obterDuracaoTotalMinutos();
            const dFim = montarData(hF, new Date());
            const dIni = new Date(dFim.getTime() - (dur * 60000));
            document.getElementById('hora-inicio').value = formatTime(dIni);
        }

        // --- 6. SALVAR / ABRIR ---
        function acaoAbrir() { document.getElementById('file-input').click(); }
        function acaoSalvar() {
            const titulo = document.getElementById('global-titulo').value || "Cronograma";
            const nomeArquivo = titulo.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
            const dados = gerarObjetoDados();
            const conteudoTexto = JSON.stringify(dados, null, 2);
            if ('showSaveFilePicker' in window) {
                window.showSaveFilePicker({ suggestedName: nomeArquivo, types: [{ description: 'Arquivo JSON', accept: { 'application/json': ['.json'] }, }], })
                .then(h => h.createWritable().then(w => w.write(conteudoTexto).then(() => w.close()))).catch(e => console.log(e));
                return;
            }
            const blob = new Blob([conteudoTexto], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = nomeArquivo;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function gerarObjetoDados() {
             const dados = { 
                tituloGlobal: document.getElementById('global-titulo').value, corGlobal: document.getElementById('global-cor-titulo').value,
                exibirTitulo: document.getElementById('chk-exibir-titulo').checked, inicio: document.getElementById('hora-inicio').value, fim: document.getElementById('hora-fim').value, 
                ignorarInicio: document.getElementById('chk-ignorar-inicio').checked, ignorarFim: document.getElementById('chk-ignorar-fim').checked,
                intervalosAtivos: document.getElementById('chk-intervalos').checked, estouroGlobal: document.getElementById('chk-estouro-global').checked, audioGlobal: document.getElementById('chk-audio-global').checked,
                fases: [] 
            };
            document.querySelectorAll('.fase-wrapper').forEach(wrap => {
                const row = wrap.querySelector('.fase-row');
                const customAudios = [];
                wrap.querySelectorAll('.audio-slot').forEach(slot => {
                    const fileIn = slot.querySelector('.aud-file');
                    let fName = slot.dataset.filename || ""; 
                    if (fileIn.files.length > 0) fName = fileIn.files[0].name;
                    customAudios.push({
                        min: slot.querySelector('.aud-min').value, sec: slot.querySelector('.aud-sec').value, dur: slot.querySelector('.aud-dur').value, loop: slot.querySelector('.aud-loop').checked,
                        fin: slot.querySelector('.aud-fin').value, fout: slot.querySelector('.aud-fout').value, playThrough: slot.querySelector('.aud-playthrough').checked,
                        stopAtZero: slot.querySelector('.aud-stopzero').checked, continueNext: slot.querySelector('.aud-continue').checked, fileName: fName
                    });
                });
                let imgName = row.dataset.imgname || "";
                const imgInput = row.querySelector('.inp-img');
                if(imgInput && imgInput.files.length > 0) imgName = imgInput.files[0].name;
                dados.fases.push({
                    titulo: row.querySelector('.inp-titulo').value, minutos: row.querySelector('.inp-tempo').value, flexivel: row.querySelector('.inp-flexivel').checked,
                    intTempo: row.querySelector('.inp-int-tempo').value, intManual: row.querySelector('.inp-int-manual').checked, estouroFase: row.querySelector('.inp-estouro-fase').checked, beepFase: row.querySelector('.inp-beep-fase').checked,
                    aviso: row.querySelector('.inp-aviso').value, bg: row.querySelector('.inp-bg').value, txt: row.querySelector('.inp-txt').value, customAudioTimes: customAudios, imgName: imgName
                });
            });
            return dados;
        }
        function carregarArquivo(input) {
            const f = input.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = e => { try { aplicarConfiguracao(JSON.parse(e.target.result)); } catch(err){ alert("Erro ao ler: " + err.message); }};
            r.readAsText(f); input.value = "";
        }
        function aplicarConfiguracao(d) {
            document.getElementById('global-titulo').value = d.tituloGlobal || "Evento"; document.getElementById('global-cor-titulo').value = d.corGlobal || "#00d2ff"; document.getElementById('global-titulo').style.color = d.corGlobal || "#00d2ff"; 
            document.getElementById('chk-exibir-titulo').checked = d.exibirTitulo || false; document.getElementById('hora-inicio').value = d.inicio || ""; document.getElementById('hora-fim').value = d.fim || "";
            document.getElementById('chk-ignorar-inicio').checked = d.ignorarInicio || false; toggleIgnorarInicio(); document.getElementById('chk-ignorar-fim').checked = d.ignorarFim || false; toggleIgnorarFim();
            document.getElementById('chk-intervalos').checked = d.intervalosAtivos; toggleIntervalosGlobais(); document.getElementById('chk-estouro-global').checked = d.estouroGlobal || false; toggleEstouroGlobal(); document.getElementById('chk-audio-global').checked = d.audioGlobal || false; toggleAudioGlobal();
            document.getElementById('lista-fases').innerHTML = ""; let usesMedia = false; 
            if (d.fases && d.fases.length > 0) {
                d.fases.forEach(f => {
                    const isFlex = (f.flexivel !== undefined) ? f.flexivel : (f.redutivel || false);
                    if (f.imgName) usesMedia = true;
                    const divWrapper = adicionarFase(f.titulo, f.minutos, isFlex, f.bg, f.txt, f.imgName || "");
                    const row = divWrapper.querySelector('.fase-row');
                    row.querySelector('.inp-int-tempo').value = f.intTempo || 0; row.querySelector('.inp-int-manual').checked = f.intManual || false; 
                    row.querySelector('.inp-estouro-fase').checked = f.estouroFase || false; row.querySelector('.inp-beep-fase').checked = (f.beepFase !== undefined) ? f.beepFase : true;
                    row.querySelector('.inp-aviso').value = f.aviso || 30; 
                    if (f.customAudioTimes && f.customAudioTimes.length > 0) {
                        usesMedia = true; const painel = divWrapper.querySelector('.audio-panel'); painel.classList.add('open');
                        f.customAudioTimes.forEach(t => { adicionarSlotAudio(painel, t.min, t.sec, t.dur, t.loop, t.fin, t.fout, t.fileName, t.playThrough, t.stopAtZero, t.continueNext); });
                    }
                    uiAtualizarFase(row); 
                });
                if (usesMedia && Object.keys(mediaCache).length === 0) document.getElementById('modal-missing-media').style.display = 'flex';
                else if (Object.keys(mediaCache).length > 0) processarPastaTrabalho({files:[]});
            }
        }

        // --- 7. L√ìGICA DE IN√çCIO E RUNTIME ---
        function iniciarApresentacao() {
            const hI = document.getElementById('hora-inicio').value;
            const hF = document.getElementById('hora-fim').value;
            const ignorarI = document.getElementById('chk-ignorar-inicio').checked;
            const ignorarF = document.getElementById('chk-ignorar-fim').checked;

            if (!ignorarI && !hI) return alert("Defina o In√≠cio.");
            if (!ignorarF && !hF) return alert("Defina o Fim.");

            const now = new Date(); 
            let dIni;
            if (ignorarI) dIni = now; else dIni = montarData(hI, now);

            if (!ignorarF) {
                dataFimGlobal = montarData(hF, now); 
                if (dataFimGlobal < dIni) dataFimGlobal.setDate(dataFimGlobal.getDate()+1);
            } else { dataFimGlobal = null; }

            // CALCULAR ATRASO EM RELA√á√ÉO AO FIM
            if (!ignorarF) {
                const durTotalMin = obterDuracaoTotalMinutos();
                const tempoDispMin = (dataFimGlobal - now) / 60000;
                const diferenca = tempoDispMin - durTotalMin; 

                if (diferenca < -1) { 
                    deficitSeconds = Math.abs(diferenca * 60);
                    construirCronograma(); 
                    if (cronograma.length === 0) return alert("Adicione etapas!");
                    
                    const firstPhaseMin = cronograma[0].segundosFinais / 60;
                    const totalDurMin = cronograma.reduce((acc,f) => acc + f.segundosFinais, 0) / 60;
                    const delayMin = Math.abs(diferenca);

                    if (delayMin > firstPhaseMin || delayMin > (totalDurMin * 0.25)) {
                        document.getElementById('modal-severe-delay').style.display = 'flex';
                        return;
                    } 
                    else {
                        document.getElementById('lbl-mod-1').innerText = `(${cronograma[0].titulo})`;
                        document.getElementById('lbl-mod-4').innerText = `(${cronograma[cronograma.length-1].titulo})`;
                        document.getElementById('modal-moderate-delay').style.display = 'flex';
                        return;
                    }
                }
            }

            if (!ignorarI && now < dIni) {
                pendingDataInicio = dIni;
                document.getElementById('modal-early-start').style.display = 'flex';
                return;
            }

            ativarWakeLock();
            construirCronograma();
            rodarSistema(now);
        }

        // --- HANDLERS DE ATRASO (STARTUP) ---
        function handleSevereAction(action) {
            document.getElementById('modal-severe-delay').style.display = 'none';
            if (action === 'cancel') return;
            if (action === 'ignore') {
                document.getElementById('chk-ignorar-fim').checked = true; toggleIgnorarFim();
                iniciarApresentacao();
            }
        }

        function handleModerateAction(opt) {
            document.getElementById('modal-moderate-delay').style.display = 'none';
            ativarWakeLock();
            
            construirCronograma(); 
            const now = new Date();
            
            if (opt === 1) {
                cronograma[0].segundosFinais = Math.max(0, cronograma[0].segundosFinais - deficitSeconds);
            }
            else if (opt === 2) {
                const timeToAdd = cronograma[0].segundosFinais / (cronograma.length - 1);
                cronograma.shift(); 
                cronograma.forEach(f => f.segundosFinais += timeToAdd);
            }
            else if (opt === 3) {
                const timePool = cronograma[0].segundosFinais;
                cronograma.shift(); 
                let flexCount = cronograma.filter(f => f.flexivel).length;
                if (flexCount > 0) {
                    cronograma.forEach(f => { if(f.flexivel) f.segundosFinais += (timePool/flexCount); });
                }
            }
            else if (opt === 4) {
                const last = cronograma.length - 1;
                cronograma[last].segundosFinais = Math.max(0, cronograma[last].segundosFinais - deficitSeconds);
            }
            else if (opt === 5) { return; }
            else if (opt === 6) {
                const durTotal = cronograma.reduce((acc,f)=>acc+f.segundosFinais,0);
                dataFimGlobal = new Date(now.getTime() + (durTotal*1000));
                document.getElementById('hora-fim').value = formatTime(dataFimGlobal);
            }
            else if (opt === 7) {
                dataFimGlobal = null;
                document.getElementById('chk-ignorar-fim').checked = true; toggleIgnorarFim();
            }

            rodarSistema(now, true);
        }

        // --- HANDLERS DE RUNTIME (ATRASO DURANTE O EVENTO) ---
        function handleRuntimeAction(action) {
            document.getElementById('modal-runtime-adjust').style.display = 'none';
            
            if (action === 'auto') {
                const now = new Date();
                const timeAvailable = (dataFimGlobal - now) / 1000;
                let futureDurationFixed = 0;
                let futureDurationFlex = 0;
                let flexIndices = [];

                for (let i = indexAtual + 1; i < cronograma.length; i++) {
                    if (cronograma[i].flexivel) {
                        futureDurationFlex += cronograma[i].segundosFinais;
                        flexIndices.push(i);
                    } else {
                        futureDurationFixed += cronograma[i].segundosFinais;
                    }
                }

                const timeForFlex = timeAvailable - futureDurationFixed;
                if (timeForFlex <= 0 || flexIndices.length === 0) {
                    alert("Imposs√≠vel ajustar automaticamente (sem fases flex√≠veis ou tempo esgotado).");
                    return; 
                }

                const factor = timeForFlex / futureDurationFlex;
                flexIndices.forEach(idx => {
                    cronograma[idx].segundosFinais = Math.floor(cronograma[idx].segundosFinais * factor);
                });
                if (tempoRestante < 0) rodarFase(indexAtual + 1);
            }
            else if (action === 'ignore') {
                dataFimGlobal = null;
                document.getElementById('chk-ignorar-fim').checked = true; toggleIgnorarFim();
                document.getElementById('lbl-fim-absoluto').innerText = "LIVRE";
                document.getElementById('lbl-fim-previsto').parentElement.style.display = 'flex';
            }
            else if (action === 'reprogram') {
                openReprogramModal();
            }
        }

        // --- REPROGRAMA√á√ÉO MANUAL ---
        function openReprogramModal() {
            const container = document.getElementById('reprogram-list');
            container.innerHTML = '';
            for (let i = indexAtual + 1; i < cronograma.length; i++) {
                const div = document.createElement('div');
                div.className = 'reprogram-row';
                div.innerHTML = `
                    <label>${cronograma[i].titulo}</label>
                    <input type="number" class="inp-reprog" data-idx="${i}" value="${Math.round(cronograma[i].segundosFinais/60)}">
                `;
                container.appendChild(div);
            }
            if (dataFimGlobal) {
                document.getElementById('new-end-time-input').value = formatTime(dataFimGlobal);
            } else {
                const now = new Date();
                document.getElementById('new-end-time-input').value = formatTime(new Date(now.getTime() + 3600000));
            }
            document.getElementById('modal-reprogram-manual').style.display = 'flex';
        }

        function applyReprogramming() {
            document.querySelectorAll('.inp-reprog').forEach(inp => {
                const idx = parseInt(inp.dataset.idx);
                const val = parseInt(inp.value);
                if (val > 0) cronograma[idx].segundosFinais = val * 60;
            });
            const newTimeStr = document.getElementById('new-end-time-input').value;
            if (newTimeStr) {
                dataFimGlobal = montarData(newTimeStr, new Date());
                if (dataFimGlobal < new Date()) dataFimGlobal.setDate(dataFimGlobal.getDate() + 1);
                document.getElementById('hora-fim').value = newTimeStr;
                document.getElementById('chk-ignorar-fim').checked = false; toggleIgnorarFim();
            }
            document.getElementById('modal-reprogram-manual').style.display = 'none';
            if (tempoRestante < 0) rodarFase(indexAtual + 1);
        }

        // --- MANIPULADORES DE TICK E FLUXO ---
        function tick() {
            if (estado !== "RODANDO" && estado !== "INTERVALO") return;
            atualizarPrevisaoEntrega();
            
            // Audio check
            if (estado === "RODANDO" && !emIntervalo && document.getElementById('chk-audio-global').checked) {
                const fase = cronograma[indexAtual];
                if (fase.customAudios) { 
                    fase.customAudios.forEach(aud => { 
                        if (aud.trigger === tempoRestante) playSmartAudio(aud); 
                    }); 
                }
            }
            if (tempoRestante === 0 && activeAudio && activeAudio.el.customFlags && activeAudio.el.customFlags.stopAtZero) { fadeAndStop(activeAudio, 2); }
            
            tempoRestante--;
            
            const abs = Math.abs(tempoRestante); const m = Math.floor(abs / 60); const s = abs % 60; 
            const sinal = tempoRestante < 0 ? "-" : "";
            const el = document.getElementById('timer-principal'); el.innerText = `${sinal}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            const bg = document.getElementById('display-screen');
            el.classList.remove('piscando-cor', 'piscando-vermelho', 'piscando-alerta-maximo'); bg.classList.remove('bg-panic');

            if (!emIntervalo) {
                if (tempoRestante > 0 && tempoRestante <= cronograma[indexAtual].aviso) el.classList.add('piscando-cor');
                else if (tempoRestante <= 0) {
                    if (tempoRestante > -180) el.classList.add('piscando-vermelho'); else el.classList.add('piscando-alerta-maximo');
                    if (tempoRestante <= -30) bg.classList.add('bg-panic');
                }
            }

            if (tempoRestante < 0) {
                if (cronograma[indexAtual].permitirEstouro || indexAtual === cronograma.length - 1) {
                    if (intervaloTimer) clearInterval(intervaloTimer); 
                    if (tempoRestante === -1) tocarBip();
                    if (dataFimGlobal && !emIntervalo) {
                        const now = new Date();
                        if (now > dataFimGlobal) {
                            if (document.getElementById('modal-runtime-adjust').style.display !== 'flex') {
                                document.getElementById('modal-runtime-adjust').style.display = 'flex';
                            }
                        }
                    }
                    intervaloTimer = setInterval(tickNegativo, 1000);
                } else { 
                    clearInterval(intervaloTimer); 
                    tocarBip(); 
                    if (emIntervalo) rodarFase(indexAtual + 1); 
                    else gerenciarIntervalo(); 
                }
            }
        }

        function tickNegativo() {
            if (estado !== "RODANDO") return;
            atualizarPrevisaoEntrega();
            tempoRestante--;
            const abs = Math.abs(tempoRestante); const m = Math.floor(abs / 60); const s = abs % 60;
            document.getElementById('timer-principal').innerText = `-${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if (Math.abs(tempoRestante) % 30 === 0) tocarBip();
            if (dataFimGlobal && new Date() > dataFimGlobal && document.getElementById('modal-runtime-adjust').style.display !== 'flex') {
                 document.getElementById('modal-runtime-adjust').style.display = 'flex';
            }
        }

        function rodarSistema(now, forceStart = false) {
            document.getElementById('config-screen').style.display='none'; 
            document.getElementById('display-screen').style.display='flex';
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            const elTit = document.getElementById('display-global-titulo');
            if (document.getElementById('chk-exibir-titulo').checked) {
                elTit.innerText = document.getElementById('global-titulo').value; elTit.style.color = document.getElementById('global-cor-titulo').value; elTit.classList.remove('hidden');
            } else elTit.classList.add('hidden');
            const hF = document.getElementById('hora-fim').value;
            const ignorarF = document.getElementById('chk-ignorar-fim').checked;
            
            if (ignorarF) {
                document.getElementById('lbl-fim-absoluto').innerText = "LIVRE";
                document.getElementById('lbl-fim-previsto').parentElement.style.display = 'flex'; 
            } else {
                document.getElementById('lbl-fim-absoluto').innerText = hF;
                document.getElementById('lbl-fim-previsto').parentElement.style.display = 'flex';
            }
            atualizarBotoes(false); indexAtual = 0; rodarFase(0);
        }

        function resolverConflitoCalc(opt) { document.getElementById('modal-conflito-calc').style.display = 'none'; }
        
        window.onload = function() {
            try {
                document.getElementById('global-cor-titulo').addEventListener('input', e => document.getElementById('global-titulo').style.color = e.target.value);
                const now = new Date();
                const stdStart = new Date(now); stdStart.setHours(9, 20, 0, 0);
                let sVal = "09:20", eVal = "10:15";
                if (now > stdStart) {
                    const h = String(now.getHours()).padStart(2, '0'), m = String(now.getMinutes()).padStart(2, '0');
                    sVal = `${h}:${m}`;
                    const endD = new Date(now.getTime() + 55 * 60000);
                    eVal = `${String(endD.getHours()).padStart(2,'0')}:${String(endD.getMinutes()).padStart(2,'0')}`;
                }
                document.getElementById('hora-inicio').value = sVal;
                document.getElementById('hora-fim').value = eVal;
                
                adicionarFase("Abertura", 10, true, "#ffcc00", "#ffffff");
                adicionarFase("Palestra Principal", 30, false, "#007bff", "#ffffff");
                
                setInterval(() => { document.getElementById('relogio-real').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }, 1000);
            } catch (err) { alert("Erro de Inicializa√ß√£o JS: " + err.message); console.error(err); }
        };
    </script>
</body>
</html>
